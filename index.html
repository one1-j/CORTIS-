<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CORTIS (V22 æœ€çµ‚ä¿®æ­£)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-color: #F0ECE6; /* 1. æ”¹å›ç±³é»ƒè‰² */
            --card-bg: #FFFFFF; 
            --text-main: #262626; --text-sub: #666666;
            --border: 1px solid #E0E0E0;
            --accent: #d63031; 
            --nav-height: 70px; --select-color: #27ae60;
            --radius: 12px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg-color); color: var(--text-main); 
            font-family: 'Noto Sans TC', 'Inter', sans-serif; margin: 0; padding: 0; 
            padding-bottom: calc(var(--nav-height) + 120px); min-height: 100vh; 
        }

        /* 3. æç¤ºè¨Šæ¯ (Toast) - ç™½è‰²åœ“è§’æ–¹æ¡† */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; width: auto; text-align: center; }
        .toast {
            padding: 10px 20px; border-radius: 20px; background: #fff; color: #000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-weight: bold; font-size: 14px;
            display: flex; align-items: center; gap: 8px; justify-content: center;
            animation: slideDown 0.3s ease-out; border: 1px solid #eee;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ğŸ”’ Lock Screen */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .pin-container { text-align: center; } .pin-title { font-size: 2rem; font-weight: 900; margin-bottom: 20px; }
        .pin-input { padding: 15px; font-size: 24px; text-align: center; letter-spacing: 10px; border: 2px solid var(--text-main); border-radius: 8px; width: 200px; background: #fff; outline: none; font-family: monospace; }

        /* é ‚éƒ¨å·¥å…· */
        .app-header { padding: 15px 15px 5px 15px; background: var(--bg-color); }
        .app-title { font-size: 24px; font-weight: 900; color: var(--text-main); margin-bottom: 10px; letter-spacing: 1px; }

        .top-container {
            background: var(--bg-color); position: sticky; top: 0; z-index: 40;
            padding: 0 15px 10px 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .search-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: stretch; }
        .search-box { flex: 1; position: relative; }
        .search-input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ccc; border-radius: 8px; background: #fff; font-size: 14px; height: 44px; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        
        .sort-btn { 
            background: var(--text-main); color: #fff; border: none; 
            padding: 0; width: 44px; border-radius: 8px; font-size: 16px; font-weight: bold; 
            height: 44px; cursor: pointer; flex-shrink: 0;
        }

        .filter-row { display: flex; gap: 10px; align-items: center; }
        /* 5. åˆ†é¡/æœˆä»½ ç½®ä¸­ */
        .filter-select { 
            flex: 1; padding: 0 10px; border: 1px solid #ccc; border-radius: 8px; 
            background: #fff; font-weight: bold; font-size: 13px; color: var(--text-main); 
            height: 40px; text-align: center; text-align-last: center;
        }

        /* 17. åŒæ­¥ç‹€æ…‹ - åœ“è§’æ­£æ–¹å½¢ */
        .sync-wrapper {
            width: 44px; height: 44px; /* èˆ‡æ’åºæŒ‰éˆ•åŒå¤§å° */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            flex-shrink: 0; border-radius: 8px; /* åœ“è§’æ­£æ–¹å½¢ */
            background: #fff; border: 1px solid #ccc;
        }
        .sync-text { font-size: 10px; font-weight: bold; color: var(--text-main); line-height: 1.2; text-align: center; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; margin-bottom: 2px; }
        .sync-wrapper.ok .sync-dot { background: #2ecc71; }
        .sync-wrapper.loading .sync-dot { background: #f1c40f; }
        .sync-wrapper.error .sync-dot { background: #e74c3c; }

        /* ç²¾ç°¡ç‰ˆçµ±è¨ˆåˆ— */
        .summary-bar {
            background: #fff; padding: 10px 20px; font-size: 13px; color: #666;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; margin: 0 15px; border-radius: 8px;
        }
        .summary-val { color: var(--text-main); font-weight: 900; font-family: monospace; font-size: 16px; }

        /* å…§å®¹å€å¡Š */
        .view-section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.2s ease; }
        #view-home { padding: 0; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 6. ç§»é™¤æ–°å¢æ¨™é¡Œæ–‡å­—ï¼Œä¿ç•™åŠŸèƒ½æŒ‰éˆ• */
        .form-header { display: flex; justify-content: flex-end; margin-bottom: 10px; }

        /* å¡ç‰‡ç¶²æ ¼ */
        .card-grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 15px; }
        @media (min-width: 768px) { .card-grid { grid-template-columns: repeat(3, 1fr); } } 
        
        .merch-card { 
            background: var(--card-bg); border: 1px solid transparent; 
            border-radius: var(--radius); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
            overflow: hidden; display: flex; flex-direction: column; position: relative; 
            transition: all 0.2s; cursor: pointer; /* æ•´å¼µå¡ç‰‡å¯é»æ“Šçœ‹å‚™è¨» */
        }
        .merch-card.selected { border: 2px solid var(--select-color); }
        
        .card-select-overlay { position: absolute; top: 12px; left: 12px; z-index: 5; }
        .custom-checkbox { width: 24px; height: 24px; border: 2px solid #fff; background: rgba(0,0,0,0.3); backdrop-filter: blur(2px); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: transparent; cursor: pointer; }
        .merch-card.selected .custom-checkbox { background: var(--select-color); border-color: var(--select-color); color: #fff; }
        
        /* 4. åœ“è§’æ–¹å½¢é€²åº¦æ¢ */
        .card-status-bar { height: 8px; background: #eee; width: 94%; margin: 3px auto 0; border-radius: 4px; display: flex; gap: 2px; overflow: hidden; }
        .status-segment { flex: 1; opacity: 0.2; background: var(--text-main); }
        .status-segment.active { opacity: 1; }
        
        .card-header { padding: 15px; padding-left: 45px; display: flex; gap: 12px; border-bottom: 1px solid #f5f5f5; }
        .card-thumb { width: 70px; height: 70px; background: #f5f5f5; border-radius: 8px; object-fit: cover; flex-shrink: 0; border: 1px solid #eee; }
        .card-title-group { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .category-tag { font-size: 10px; background: #f0f0f0; color: #666; padding: 2px 8px; border-radius: 12px; font-weight: 600; display: inline-block; margin-bottom: 4px; width: fit-content; }
        .group-tag { font-size: 10px; background: var(--text-main); color: #fff; padding: 2px 8px; border-radius: 12px; font-weight: 600; display: inline-block; margin-bottom: 4px; margin-right: 5px; width: fit-content; }
        .remove-group { cursor: pointer; margin-left: 5px; opacity: 0.7; }
        
        /* 10. æ¨™é¡Œå¤ªé•·è™•ç† */
        .card-title { 
            font-size: 16px; font-weight: 800; margin: 0 0 3px 0; line-height: 1.3;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .card-subtitle { font-size: 12px; color: #888; }
        
        .info-grid { padding: 12px 15px; display: grid; grid-template-columns: 80px 1fr; gap: 6px; font-size: 13px; align-items: baseline; }
        .label { color: #888; font-weight: 500; text-align-last: justify; }
        .value { font-weight: 600; text-align: right; font-family: 'Inter', monospace; color: #333; }
        .value.highlight { font-weight: 900; font-size: 15px; border-top: 1px dashed #eee; padding-top: 5px; margin-top: 5px; color: #000; }
        
        /* 11. å‚™è¨»é¡¯ç¤ºå€ (é»æ“Šå±•é–‹) */
        .note-container {
            display: none; /* é è¨­éš±è— */
            padding: 10px 15px; background: #fffbe6; font-size: 12px; color: #555;
            border-top: 1px solid #f0f0f0; text-align: center;
        }
        .note-container.show { display: block; }

        /* 8. & 9. ç‹€æ…‹å‹¾é¸å€ (é‡æ–°è¨­è¨ˆ) */
        .checklist-col { 
            padding: 10px 15px; background: #fff; border-top: 1px solid #f5f5f5; 
            display: flex; flex-direction: column; gap: 8px;
        }
        .check-group { 
            display: grid; grid-template-columns: 20px 70px 1fr; align-items: center; 
            font-size: 12px; color: #999; 
        }
        /* 2. æ–¹æ¡†ç„¡å‹¾å‹¾ */
        .check-box { width: 14px; height: 14px; border: 1px solid #ccc; border-radius: 3px; background: #fff; transition: 0.2s; }
        .check-group.checked .check-box { background: var(--text-main); border-color: var(--text-main); }
        .check-group.checked .check-label { font-weight: bold; color: #000; }
        .check-left { display: flex; align-items: center; cursor: pointer; height: 100%; }
        
        .mini-date {
            border: none; background: #f9f9f9; font-size: 11px; color: #333;
            text-align: center; width: 100%; font-family: 'Inter', monospace;
            padding: 2px 5px; border-radius: 4px; visibility: hidden;
        }
        .check-group.checked .mini-date { visibility: visible; }

        /* 12. è³£å®¶è¯çµ¡è³‡è¨Š (ç§»è‡³åº•éƒ¨) */
        .seller-info {
            padding: 8px 15px; background: #fcfcfc; border-top: 1px solid #f5f5f5;
            font-size: 11px; color: #666; text-align: center; display: flex; justify-content: space-between;
        }
        .seller-link { color: #000; text-decoration: underline; cursor: pointer; }

        .card-actions { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; background: #fff; border-top: 1px solid #f5f5f5; }
        .action-btn { background: transparent; border: none; padding: 12px 0; font-size: 12px; font-weight: 600; border-right: 1px solid #f5f5f5; color: #555; cursor: pointer; }
        .action-btn:last-child { border: none; }
        .action-btn:active { background: #f9f9f9; }

        /* è¡¨å–®æ¨£å¼ */
        .form-container { background: var(--card-bg); padding: 25px; border: var(--border); border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-col { flex: 1; width: 50%; } 
        .form-group { margin-bottom: 18px; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 6px; color: #333; }
        input, select, textarea { 
            width: 100%; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; background: #fcfcfc; font-size: 15px; 
            color: var(--text-main); height: 44px; line-height: 44px; box-sizing: border-box; -webkit-appearance: none; appearance: none; transition: border 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: #666; outline: none; background: #fff; }
        textarea { height: 80px; line-height: 1.5; padding: 10px; }
        input[type="file"] { padding: 10px; line-height: 1.2; height: auto; border: 1px dashed #ccc; }
        .btn-main { width: 100%; background: var(--text-main); color: #fff; padding: 15px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; letter-spacing: 1px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-main:active { transform: scale(0.98); }
        
        /* 1. é€£çµè¼¸å…¥æ¡†æ”¹ç‚ºå‚ç›´æ’åˆ— */
        .link-group { display: flex; flex-direction: column; gap: 10px; }

        #transferFields { background: #f4f4f4; border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .info-input-grid { display: flex; gap: 10px; background: #f9f9f9; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .info-input-item { flex: 1; text-align: center; }
        .info-input-item label { font-size: 11px; color: #666; }
        .info-input-item input { text-align: right; background: #fff; }

        /* 4. & 7. è³‡æ–™ç®¡ç† - æ¨£å¼å„ªåŒ– (ç²—é«”ã€ç™½è‰²åœ“è§’) */
        .section-header { font-size: 14px; color: #333; font-weight: 900; margin: 25px 0 10px 5px; }
        
        .clean-btn-group { display: flex; flex-direction: column; gap: 10px; }
        .clean-btn {
            background: #fff; border: 1px solid #ddd; 
            color: var(--text-main); padding: 16px; border-radius: 12px;
            font-weight: 700; font-size: 15px; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.1s;
        }
        .clean-btn:active { transform: scale(0.98); background: #f9f9f9; }
        .clean-btn span { font-size: 18px; margin-right: 10px; }
        
        /* åˆªé™¤æŒ‰éˆ•ç¶­æŒé»ƒè‰²èª¿ (bg-color) */
        .clean-btn.danger { background: #FDE8E8; border-color: #F8B4B4; color: #C0392B; }

        /* è¨­å®šé¸å–®æŒ‰éˆ• */
        .settings-menu-btn {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 18px; background: #fff; border: none; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 12px; font-weight: 700; font-size: 15px; cursor: pointer;
            text-align: left; border-radius: 12px; color: #333;
        }

        /* 5. å®‰å…¨æ€§é–‹é—œ */
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #fff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .toggle-label { font-weight: 900; font-size: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #eee; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--text-main); }
        input:checked + .slider:before { transform: translateX(24px); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        .nav-item { flex: 1; text-align: center; color: #aaa; font-size: 10px; font-weight: 600; cursor: pointer; padding-top: 10px; transition: color 0.2s; }
        .nav-item.active { color: var(--text-main); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 3px; }

        /* 14. æ‰¹é‡æ“ä½œåˆ— (é è¨­éš±è—) */
        .bulk-actions-bar { 
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(150px); 
            background: var(--text-main); color: #fff; padding: 10px 20px; 
            display: none; /* 14. é è¨­ä¸é¡¯ç¤ºï¼ŒJS æ§åˆ¶é¡¯ç¤º */
            gap: 10px; align-items: center; border-radius: 50px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: transform 0.3s; z-index: 99; 
            white-space: nowrap; overflow-x: auto; max-width: 90%; 
        }
        .bulk-actions-bar.active { display: flex; transform: translateX(-50%) translateY(0); }
        .bulk-btn { background: #fff; color: #000; border: none; padding: 5px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .bulk-btn.danger { background: var(--accent); color: #fff; }
        .bulk-btn.select-all { background: #f39c12; color: #fff; }

        .hidden { display: none; }
        .text-red { color: var(--accent); }
    </style>
</head>
<body>

    <div id="lockScreen">
        <div class="pin-container">
            <div class="pin-title">LOCKED</div>
            <div class="pin-msg">è«‹è¼¸å…¥ PIN ç¢¼</div>
            <input type="password" id="pinInput" class="pin-input" maxlength="4" pattern="[0-9]*" inputmode="numeric">
        </div>
    </div>

    <!-- åˆ—è¡¨é  -->
    <div id="view-home" class="view-section active">
        
        <div class="app-header">
            <!-- 7. è¿½æ˜Ÿè¨˜å¸³å¤§æ¨™é¡Œ -->
            <div class="app-title">è¿½æ˜Ÿè¨˜å¸³</div>
        </div>

        <div class="top-container">
            <div class="search-row">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å•†å“åç¨±..." oninput="renderList()">
                </div>
                <div class="right-tools">
                    <button class="sort-btn" onclick="toggleSort()">â‡…</button>
                    <!-- 17. åŒæ­¥ç‹€æ…‹èˆ‡æ’åºæŒ‰éˆ•å°é½Š -->
                    <div id="syncWrapper" class="sync-wrapper ok">
                        <div class="sync-dot"></div>
                        <div class="sync-text" id="syncText">å·²åŒæ­¥</div>
                    </div>
                </div>
            </div>
            <div class="filter-row">
                <select id="monthFilter" class="filter-select" onchange="renderList()">
                    <option value="all">ğŸ“… æ‰€æœ‰æœˆä»½</option>
                </select>
                <select id="categoryFilter" class="filter-select" onchange="renderList()">
                    <option value="all">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>
                    <option value="å‘¨é‚Š">å‘¨é‚Š</option>
                    <option value="å°ˆè¼¯">å°ˆè¼¯</option>
                    <option value="å°å¡">å°å¡</option>
                    <option value="ç¥¨å‹™">ç¥¨å‹™</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
        </div>

        <div class="summary-bar">
            <span>ç•¶å‰èŠ±è²»</span>
            <span class="summary-val" id="summaryTotal">NT$ 0</span>
            <span style="font-size:12px; margin-left:10px;">( <span id="summaryCount">0</span> ç­† )</span>
        </div>

        <div id="merchGrid" class="card-grid" style="margin-top:15px;"></div>
        <div id="emptyState" style="text-align:center; padding:50px; color:#999; display:none;">ç›®å‰æ²’æœ‰ç´€éŒ„</div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯é  -->
    <div id="view-add" class="view-section">
        <!-- 6. ç§»é™¤ã€Œæ–°å¢ç´€éŒ„ã€æ¨™é¡Œ -->
        <div class="form-container">
            <form id="merchForm">
                <input type="hidden" id="editId">
                <div class="form-group"><label>å•†å“åç¨± <span style="color:red">*</span></label><input type="text" id="name" required></div>
                
                <div class="form-row">
                    <div class="form-col">
                        <label>åˆ†é¡</label>
                        <select id="category"><option>å‘¨é‚Š</option><option>å°ˆè¼¯</option><option>å°å¡</option><option>ç¥¨å‹™</option><option>å…¶ä»–</option></select>
                    </div>
                    <div class="form-col">
                        <label>è³¼è²·ä¾†æº</label>
                        <input type="text" id="source" placeholder="ä¾‹: å®˜ç¶²">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ä¸‹å–®æ—¥æœŸ <span style="color:red">*</span></label>
                    <input type="date" id="orderDate" required>
                </div>
                
                <div class="form-group">
                    <label>è³£å®¶è¯çµ¡è³‡è¨Š</label>
                    <div class="form-row" style="margin-bottom:0;">
                        <div class="form-col"><input type="text" id="contact" placeholder="åç¨± (ä¾‹: æ¨ç‰¹@abc)"></div>
                        <div class="form-col"><input type="url" id="contactLink" placeholder="é€£çµ (é¸å¡«)"></div>
                    </div>
                </div>

                <div class="form-group"><label>ä»˜æ¬¾æ–¹å¼</label>
                    <select id="paymentType" onchange="toggleTransferFields()">
                        <option value="Pending">å¾…ä»˜æ¬¾</option>
                        <option value="COD">è²¨åˆ°ä»˜æ¬¾</option>
                        <option value="Transfer">éŠ€è¡ŒåŒ¯æ¬¾</option>
                    </select>
                </div>

                <div id="transferFields" class="hidden">
                    <div class="form-row">
                        <div class="form-col"><label>åŒ¯æ¬¾æ—¥æœŸ</label><input type="date" id="transferDate"></div>
                        <div class="form-col"><label>é‡‘é¡</label><input type="number" id="transferAmount"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>è²»ç”¨ (NT$)</label>
                    <div class="info-input-grid">
                        <div class="info-input-item"><label>å–®åƒ¹</label><input type="number" id="price"></div>
                        <div class="info-input-item"><label>äºŒè£œ</label><input type="number" id="secondPay"></div>
                        <div class="info-input-item"><label>åœ‹å…§é‹è²»</label><input type="number" id="shipping"></div>
                    </div>
                </div>

                <!-- 1. é€£çµå€å‚ç›´æ’åˆ— -->
                <div class="form-group">
                    <label>ç›¸é—œé€£çµ</label>
                    <div class="link-group">
                        <input type="url" id="link" placeholder="ä¸‹å–®é€£çµ (è¨‚è³¼ç¶²å€)...">
                        <input type="url" id="reconcileLink" placeholder="å°å¸³è¡¨é€£çµ...">
                    </div>
                </div>
                
                <div class="form-group"><label>å‚™è¨»</label><textarea id="notes" style="height:60px;"></textarea></div>
                
                <div class="form-group">
                    <label>åœ–ç‰‡</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="file" id="imageInput" accept="image/*" style="flex:1;">
                        <!-- 18. åˆªé™¤ç…§ç‰‡æŒ‰éˆ• -->
                        <button type="button" onclick="clearImageInput()" style="background:#eee; border:1px solid #ccc; padding:10px; border-radius:8px;">ğŸ—‘</button>
                    </div>
                </div>
                
                <button type="submit" class="btn-main" id="submitBtn">å„²å­˜</button>
                <button type="button" class="btn-main" id="cancelBtn" onclick="resetForm()" style="background:#999; margin-top:10px; display:none;">å–æ¶ˆç·¨è¼¯</button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†é  -->
    <div id="view-settings" class="view-section">
        <h2 class="page-title">ç®¡ç†</h2>
        <button class="settings-menu-btn" onclick="openSubPage('data')">ğŸ“‚ è³‡æ–™åŒ¯å…¥ / å‚™ä»½</button>
        <button class="settings-menu-btn" onclick="openSubPage('security')">ğŸ”’ å®‰å…¨æ€§è¨­å®š</button>
    </div>

    <!-- è³‡æ–™ç®¡ç†å­é é¢ (4. å„ªåŒ–æ’ç‰ˆ) -->
    <div id="view-settings-data" class="view-section">
        <h2 class="page-title"><button class="back-btn" onclick="openSubPage('main')">â†</button> è³‡æ–™ç®¡ç†</h2>
        
        <div class="section-header">Excel æ•´åˆ</div>
        <div class="clean-btn-group">
            <button class="clean-btn" onclick="downloadTemplate()">ğŸ“Š ä¸‹è¼‰ Excel ç¯„æœ¬ <span>â€º</span></button>
            <div style="position:relative;">
                <button class="clean-btn" style="width:100%" onclick="document.getElementById('excelInput').click()">ğŸ“¥ åŒ¯å…¥ Excel æª”æ¡ˆ <span>â€º</span></button>
                <input type="file" id="excelInput" onchange="importExcel(this)" accept=".xlsx, .xls, .csv" style="display:none;">
            </div>
        </div>

        <div class="section-header">ç³»çµ±å‚™ä»½</div>
        <div class="clean-btn-group">
            <button class="clean-btn" onclick="exportData()">â¬‡ ä¸‹è¼‰ JSON å‚™ä»½ <span>â€º</span></button>
            <div style="position:relative;">
                <button class="clean-btn" style="width:100%" onclick="document.getElementById('jsonInput').click()">â¬† åŒ¯å…¥ JSON å‚™ä»½ <span>â€º</span></button>
                <input type="file" id="jsonInput" onchange="importData(this)" accept=".json" style="display:none;">
            </div>
        </div>

        <div class="section-header">é›²ç«¯èˆ‡é‡ç½®</div>
        <div class="clean-btn-group">
            <button class="clean-btn" onclick="forceCloudSync()">â˜ å¼·åˆ¶é›²ç«¯åŒæ­¥ <span>â€º</span></button>
            <button class="clean-btn danger" onclick="clearAllData()">âš  æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

    <!-- å®‰å…¨æ€§å­é é¢ -->
    <div id="view-settings-security" class="view-section">
        <h2 class="page-title"><button class="back-btn" onclick="openSubPage('main')">â†</button> å®‰å…¨æ€§</h2>
        
        <div class="toggle-switch">
            <span class="toggle-label">å•Ÿç”¨ PIN ç¢¼é–å®š</span>
            <label class="switch"><input type="checkbox" id="pinToggle" onchange="togglePinSetting()"><span class="slider"></span></label>
        </div>
        
        <div id="pinChangeArea" class="hidden" style="margin-top:20px;">
            <input type="number" id="newPinInput" placeholder="è¼¸å…¥æ–° PIN (4ç¢¼)" style="margin-bottom:10px;" maxlength="4">
            <button class="btn-main" onclick="saveNewPin()">å„²å­˜æ–°å¯†ç¢¼</button>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œåˆ— -->
    <div id="bulkActions" class="bulk-actions-bar">
        <div style="font-size:12px;">å·²é¸ <span id="selectedCount">0</span> ç­†</div>
        <button class="bulk-btn select-all" onclick="selectAllVisible()">âœ… å…¨é¸</button>
        <button class="bulk-btn" onclick="mergeSelectedItems()">ğŸ”— åˆä½µ</button>
        <button class="bulk-btn danger" onclick="deleteSelectedItems()">ğŸ—‘ åˆªé™¤</button>
        <button class="bulk-btn" onclick="clearSelection()" style="background:#666; color:#fff;">å–æ¶ˆ</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchView('home', this)"><span class="nav-icon">â˜°</span>åˆ—è¡¨</div>
        <div class="nav-item" onclick="switchView('add', this)"><span class="nav-icon">ï¼‹</span>æ–°å¢</div>
        <div class="nav-item" onclick="switchView('settings', this)"><span class="nav-icon">âš™</span>ç®¡ç†</div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyeGblocTD-g8e3yUbG0YSMBRbT-6Uwfu2gF09Bjgqt32C_GIjBwnl-Ni2-cfDwXQfl4g/exec";
        const STORAGE_KEY = 'cortis_v22_data';
        const SETTINGS_KEY = 'cortis_v22_settings';
        
        let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let appSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { pinEnabled: false, pin: "0000" };
        
        let sortDesc = true;
        let selectedIds = new Set();
        let isSyncing = false;
        let currentImage = null; // ç”¨ä¾†æš«å­˜ç·¨è¼¯æ™‚çš„åœ–ç‰‡

        const views = { 
            home: document.getElementById('view-home'), 
            add: document.getElementById('view-add'), 
            settings: document.getElementById('view-settings'),
            settingsData: document.getElementById('view-settings-data'),
            settingsSecurity: document.getElementById('view-settings-security')
        };
        const STATUS_KEYS = ['notArrived', 'pendingShip', 'shipped', 'pickedUp'];
        const STATUS_LABELS = { notArrived:'æœªåˆ°è²¨', pendingShip:'å¾…å‡ºè²¨', shipped:'å·²å‡ºè²¨', pickedUp:'å–è²¨' };
        const PAYMENT_LABELS = { Pending:'å¾…ä»˜æ¬¾', COD:'è²¨åˆ°ä»˜æ¬¾', Transfer:'éŠ€è¡ŒåŒ¯æ¬¾' };

        window.onload = () => {
            document.getElementById('pinToggle').checked = appSettings.pinEnabled;
            if(appSettings.pinEnabled) {
                document.getElementById('lockScreen').style.display = 'flex';
                document.getElementById('pinInput').addEventListener('input', checkPin);
                document.getElementById('pinInput').focus();
            } else {
                initApp();
            }
        };

        // 3. æç¤º Toast (3ç§’)
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            container.innerHTML = ''; // æ¸…é™¤èˆŠçš„
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'âœ…' : 'âŒ';
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${icon} ${message}</span><button onclick="this.parentElement.remove()">Ã—</button>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        function checkPin(e) {
            if (e.target.value === appSettings.pin) {
                document.getElementById('lockScreen').style.display = 'none';
                initApp();
            }
        }

        function initApp() {
            renderList(); populateMonthFilter();
            document.getElementById('orderDate').valueAsDate = new Date();
            updateSyncStatus('ready');
            syncWithCloud();
        }

        // --- æ ¸å¿ƒé‚è¼¯ä¿®æ­£ï¼šå„²å­˜ ---
        const form = document.getElementById('merchForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // é˜²æ­¢é€£é»
            const btn = document.getElementById('submitBtn');
            if(btn.disabled) return;
            btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;

            if(!document.getElementById('name').value || !document.getElementById('orderDate').value) {
                showToast("è«‹å¡«å¯«å•†å“åç¨±èˆ‡ä¸‹å–®æ—¥æœŸ", "error"); 
                btn.innerText = "å„²å­˜"; btn.disabled = false; return;
            }

            try {
                const editId = document.getElementById('editId').value;
                const imgInput = document.getElementById('imageInput');
                let imgData = currentImage; // é è¨­ä½¿ç”¨æš«å­˜çš„åœ–ç‰‡ (ç·¨è¼¯æ™‚)
                
                // å¦‚æœæœ‰æ–°ä¸Šå‚³ï¼Œå‰‡è¦†è“‹
                if(imgInput.files && imgInput.files[0]) {
                    try { imgData = await compressImage(imgInput.files[0]); } 
                    catch(err) { console.warn("åœ–ç‰‡è™•ç†å¤±æ•—"); }
                }

                const rawData = {
                    name: document.getElementById('name').value, category: document.getElementById('category').value,
                    orderDate: document.getElementById('orderDate').value, source: document.getElementById('source').value, 
                    contact: document.getElementById('contact').value, contactLink: document.getElementById('contactLink').value,
                    paymentType: document.getElementById('paymentType').value, transferDate: document.getElementById('transferDate').value, 
                    transferAmount: Number(document.getElementById('transferAmount').value), price: Number(document.getElementById('price').value), 
                    secondPay: Number(document.getElementById('secondPay').value), shipping: Number(document.getElementById('shipping').value), 
                    link: document.getElementById('link').value, reconcileLink: document.getElementById('reconcileLink').value,
                    // 13. å–æ¶ˆè³£è²¨ä¾¿é€£çµï¼Œè¨‚è³¼é€£çµæ”¹å
                    // sellerLink: document.getElementById('sellerLink').value, (å·²ç§»é™¤)
                    notes: document.getElementById('notes').value
                };

                if(editId) {
                    const idx = items.findIndex(i => i.id == editId);
                    if(idx > -1) {
                        items[idx] = { ...items[idx], ...rawData, imageSrc: imgData };
                    }
                } else {
                    items.unshift({ 
                        id: Date.now(), ...rawData, imageSrc: imgData, group:null, 
                        status: {notArrived:true, pendingShip:false, shipped:false, pickedUp:false},
                        dates: {pendingShip:'', shipped:'', pickedUp:''},
                        refund: { isRefunded: false } 
                    });
                }

                saveData(); 
                resetForm(); 
                populateMonthFilter();
                switchView('home', document.querySelectorAll('.nav-item')[0]);
                showToast("æ–°å¢æˆåŠŸï¼");
                
            } catch (error) { 
                showToast("å„²å­˜å¤±æ•—", "error"); 
                console.error(error);
            } finally { 
                btn.innerText = "å„²å­˜"; btn.disabled = false; 
            }
        });

        // 18. åˆªé™¤ç…§ç‰‡
        function clearImageInput() {
            document.getElementById('imageInput').value = '';
            currentImage = '';
        }

        // --- ç‹€æ…‹æ›´æ–° (15. å–æ¶ˆå‹¾é¸æ¸…ç©ºæ—¥æœŸ) ---
        function toggleStatus(id, key) {
            const item = items.find(i => i.id === id);
            if(item) {
                const newStatus = !item.status[key];
                item.status[key] = newStatus;
                
                if(newStatus && ['pendingShip', 'shipped', 'pickedUp'].includes(key)) {
                    if(!item.dates) item.dates = {};
                    if(!item.dates[key]) item.dates[key] = new Date().toISOString().split('T')[0];
                } else if (!newStatus) {
                    // å–æ¶ˆå‹¾é¸æ™‚æ¸…ç©ºæ—¥æœŸ
                    if(item.dates) item.dates[key] = '';
                }
                saveData(); renderList();
            }
        }

        function updateStatusDate(id, key, dateValue) {
            const item = items.find(i => i.id === id);
            if(item) {
                if(!item.dates) item.dates = {};
                item.dates[key] = dateValue;
                if(dateValue && !item.status[key]) item.status[key] = true;
                saveData();
            }
        }

        // --- åˆ—è¡¨æ¸²æŸ“ ---
        function renderList() {
            const grid = document.getElementById('merchGrid'); grid.innerHTML = '';
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const monthVal = document.getElementById('monthFilter').value;
            const catVal = document.getElementById('categoryFilter').value;

            let filtered = items.filter(i => {
                const matchK = (i.name||'').toLowerCase().includes(keyword);
                const matchM = monthVal === 'all' || i.orderDate.startsWith(monthVal);
                const matchC = catVal === 'all' || i.category === catVal;
                return matchK && matchM && matchC;
            });

            filtered.sort((a,b) => sortDesc ? new Date(b.orderDate)-new Date(a.orderDate) : new Date(a.orderDate)-new Date(b.orderDate));
            document.getElementById('emptyState').style.display = filtered.length ? 'none' : 'block';
            updateSummary(filtered);

            filtered.forEach(item => {
                const total = (item.price||0) + (item.secondPay||0) + (item.shipping||0);
                
                // 9. ç‹€æ…‹æ’ç‰ˆå„ªåŒ– (Grid)
                let checksHtml = '';
                STATUS_KEYS.forEach(k => {
                    const checked = item.status[k] ? 'checked' : '';
                    const dateVal = (item.dates && item.dates[k]) ? item.dates[k] : '';
                    let dateInputHtml = '';
                    if (['pendingShip', 'shipped', 'pickedUp'].includes(k)) {
                        // ç¢ºä¿æ—¥æœŸè¼¸å…¥æ¡†å­˜åœ¨ï¼Œå³ä½¿æ²’å‹¾é¸ (ç”¨ visibility æ§åˆ¶)
                        const style = checked ? '' : 'visibility:hidden';
                        dateInputHtml = `<input type="date" class="mini-date" value="${dateVal}" style="${style}" onchange="updateStatusDate(${item.id}, '${k}', this.value)" onclick="event.stopPropagation()">`;
                    }
                    checksHtml += `
                        <div class="check-group ${checked}">
                            <div class="check-left" onclick="toggleStatus(${item.id}, '${k}')">
                                <div class="check-box"></div>
                                <span class="check-label">${STATUS_LABELS[k]}</span>
                            </div>
                            ${dateInputHtml}
                        </div>`;
                });

                let contactDisplay = item.contact || '-';
                if(item.contactLink) contactDisplay = `<a class="contact-link" onclick="window.open('${item.contactLink}', '_blank')">${item.contact || 'é€£çµ'}</a>`;
                let groupHtml = item.group ? `<span class="group-tag">ğŸ“¦ ${item.group} <span class="remove-group" onclick="ungroupItem(${item.id})">Ã—</span></span>` : '';
                const isSelected = selectedIds.has(item.id) ? 'selected' : '';
                const checkMark = selectedIds.has(item.id) ? 'âœ”' : '';
                const openUrl = (url) => url ? `window.open('${url}','_blank')` : '';
                const btnStyle = (url) => url ? '' : 'color:#ccc; cursor:default;';

                // 11. å‚™è¨»é¡¯ç¤ºé‚è¼¯
                const noteText = item.notes ? item.notes : "ç„¡å‚™è¨»";
                
                const card = document.createElement('div');
                card.className = `merch-card ${isSelected}`;
                // é»æ“Šå¡ç‰‡é¡¯ç¤ºå‚™è¨»
                card.onclick = (e) => {
                    // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•æˆ– checkboxï¼Œä¸è§¸ç™¼
                    if(e.target.closest('.action-btn') || e.target.closest('.card-select-overlay') || e.target.closest('.check-left') || e.target.tagName === 'INPUT') return;
                    const noteDiv = card.querySelector('.note-container');
                    noteDiv.classList.toggle('show');
                };

                card.innerHTML = `
                    <div class="card-select-overlay" onclick="toggleSelection(${item.id}); event.stopPropagation();"><div class="custom-checkbox">${checkMark}</div></div>
                    <div class="card-status-bar">${STATUS_KEYS.map(k => `<div class="status-segment ${item.status[k]?'active':''}"></div>`).join('')}</div>
                    <div class="card-header">${item.imageSrc ? `<img src="${item.imageSrc}" class="card-thumb">` : `<div class="card-thumb"></div>`}
                        <div class="card-title-group"><div>${groupHtml}<span class="category-tag">${item.category||'å‘¨é‚Š'}</span></div><div class="card-title">${item.name}</div><div class="card-subtitle">${item.orderDate} Â· ${item.source||''}</div></div>
                    </div>
                    <div class="info-grid">
                        <span class="label">ä»˜æ¬¾æ–¹å¼</span><span class="value" style="font-size:13px;">${PAYMENT_LABELS[item.paymentType] || item.paymentType}</span>
                        <span class="label">å–®åƒ¹</span><span class="value">${item.price||0}</span>
                        <span class="label">äºŒè£œ</span><span class="value">${item.secondPay||0}</span>
                        <span class="label">åœ‹å…§é‹è²»</span><span class="value">${item.shipping||0}</span>
                        <span class="label" style="font-weight:900; color:#000;">ç¸½è¨ˆ</span><span class="value highlight">NT$ ${total}</span>
                    </div>
                    
                    <div class="note-container">${noteText}</div>
                    
                    <div class="checklist-col">${checksHtml}</div>
                    
                    <!-- 12. è³£å®¶è¯çµ¡ç§»è‡³åº•éƒ¨ -->
                    <div class="seller-info"><span>è³£å®¶è³‡è¨Š</span><span>${contactDisplay}</span></div>

                    <div class="card-actions">
                        <button class="action-btn" onclick="editItem(${item.id})">ç·¨è¼¯</button>
                        <button class="action-btn" onclick="${openUrl(item.link)}" style="${btnStyle(item.link)}">ä¸‹å–®é€£çµ</button>
                        <button class="action-btn" onclick="${openUrl(item.reconcileLink)}" style="${btnStyle(item.reconcileLink)}">å°å¸³è¡¨</button>
                        <button class="action-btn text-red" onclick="deleteItem(${item.id})">åˆªé™¤</button>
                    </div>`;
                grid.appendChild(card);
            });
            updateBulkBar();
        }

        // --- æ‰¹é‡æ“ä½œ (ä¿®å¾© 16) ---
        function toggleSelection(id) { 
            if(selectedIds.has(id)) selectedIds.delete(id); 
            else selectedIds.add(id); 
            renderList(); 
        }
        function clearSelection() { selectedIds.clear(); renderList(); }
        
        // 14. åªæœ‰åœ¨åˆ—è¡¨é æ‰é¡¯ç¤ºæ‰¹é‡æ“ä½œ
        function updateBulkBar() { 
            const bar = document.getElementById('bulkActions'); 
            const isHome = document.getElementById('view-home').classList.contains('active');
            if(selectedIds.size > 0 && isHome) { 
                bar.classList.add('active'); 
                document.getElementById('selectedCount').innerText = selectedIds.size; 
            } else { 
                bar.classList.remove('active'); 
            } 
        }

        function mergeSelectedItems() { 
            const name = prompt("è¼¸å…¥ä½µå–®åç¨±:"); 
            if(name) { 
                items.forEach(i => { if(selectedIds.has(i.id)) i.group = name; }); 
                clearSelection(); saveData(); renderList(); 
            } 
        }
        function deleteSelectedItems() { 
            if(confirm(`ç¢ºå®šåˆªé™¤é¸å–çš„ ${selectedIds.size} ç­†è³‡æ–™ï¼Ÿ`)) { 
                items = items.filter(i => !selectedIds.has(i.id)); 
                clearSelection(); saveData(); renderList(); populateMonthFilter(); 
            } 
        }

        // --- å…¶ä»– ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                        const maxW = 600; const scale = maxW/img.width;
                        const w = (scale<1)?maxW:img.width; const h = (scale<1)?img.height*scale:img.height;
                        cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                        resolve(cvs.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function updateSyncStatus(status) {
            const wrapper = document.getElementById('syncWrapper');
            const text = document.getElementById('syncText');
            wrapper.className = 'sync-wrapper ' + status;
            if(status === 'loading') text.innerText = 'åŒæ­¥ä¸­';
            else if(status === 'ok') text.innerText = 'å·²åŒæ­¥';
            else if(status === 'error') text.innerText = 'å¤±æ•—';
            else text.innerText = 'å¾…å‘½';
        }

        async function syncWithCloud() {
            if(isSyncing) return; isSyncing = true; updateSyncStatus('loading');
            try {
                const res = await fetch(API_URL); const cloudData = await res.json();
                if(Array.isArray(cloudData) && cloudData.length >= items.length) {
                    items = cloudData; localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                    renderList(); populateMonthFilter();
                }
                updateSyncStatus('ok');
            } catch(e) { updateSyncStatus('error'); } finally { isSyncing = false; }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); updateSummary();
                fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(items) });
            } catch (e) { showToast("å„²å­˜ç©ºé–“ä¸è¶³", "error"); }
        }

        function switchView(view, el) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            views[view].classList.add('active'); 
            if(el) el.classList.add('active');
            if(view === 'home') renderList();
            window.scrollTo(0,0);
            updateBulkBar(); // åˆ‡æ›é é¢æ™‚æ›´æ–°
        }

        function openSubPage(page) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            if(page === 'main') views.settings.classList.add('active');
            else if(page === 'data') views.settingsData.classList.add('active');
            else if(page === 'security') views.settingsSecurity.classList.add('active');
            window.scrollTo(0,0);
        }

        function populateMonthFilter() {
            const select = document.getElementById('monthFilter');
            const currentVal = select.value;
            const months = [...new Set(items.map(i => i.orderDate.substring(0, 7)))].sort().reverse();
            let html = '<option value="all">ğŸ“… æ‰€æœ‰æœˆä»½</option>';
            months.forEach(m => { const [y, mm] = m.split('-'); html += `<option value="${m}">${y}å¹´ ${mm}æœˆ</option>`; });
            select.innerHTML = html;
            if(months.includes(currentVal)) select.value = currentVal; else select.value = "all";
        }

        function updateSummary(filteredItems = items) {
            const total = filteredItems.reduce((acc, i) => acc + (i.price||0) + (i.secondPay||0) + (i.shipping||0), 0);
            document.getElementById('summaryTotal').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('summaryCount').innerText = filteredItems.length;
        }

        function toggleSort() { sortDesc = !sortDesc; renderList(); }
        function selectAllVisible() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const monthVal = document.getElementById('monthFilter').value;
            const catVal = document.getElementById('categoryFilter').value;
            const filtered = items.filter(i => {
                const matchK = (i.name||'').toLowerCase().includes(keyword);
                const matchM = monthVal === 'all' || i.orderDate.startsWith(monthVal);
                const matchC = catVal === 'all' || i.category === catVal;
                return matchK && matchM && matchC;
            });
            filtered.forEach(i => selectedIds.add(i.id));
            renderList();
        }
        function ungroupItem(id) { if(confirm("ç§»é™¤ä½µå–®ï¼Ÿ")) { const i = items.find(x => x.id === id); if(i) { i.group = null; saveData(); renderList(); } } }
        
        function editItem(id) {
            const item = items.find(i => i.id === id); if(!item) return;
            document.getElementById('editId').value = item.id; document.getElementById('name').value = item.name;
            document.getElementById('category').value = item.category; document.getElementById('orderDate').value = item.orderDate;
            document.getElementById('source').value = item.source || ''; document.getElementById('contact').value = item.contact;
            document.getElementById('contactLink').value = item.contactLink || ''; document.getElementById('paymentType').value = item.paymentType; 
            document.getElementById('transferDate').value = item.transferDate; document.getElementById('transferAmount').value = item.transferAmount; 
            document.getElementById('price').value = item.price; document.getElementById('secondPay').value = item.secondPay; 
            document.getElementById('shipping').value = item.shipping; document.getElementById('link').value = item.link; 
            document.getElementById('reconcileLink').value = item.reconcileLink || ''; 
            // è³£è²¨ä¾¿å·²ç§»é™¤
            document.getElementById('notes').value = item.notes; 
            currentImage = item.imageSrc; // æš«å­˜èˆŠåœ–
            toggleTransferFields();
            document.getElementById('pageTitle').innerText = "ç·¨è¼¯ç´€éŒ„"; document.getElementById('submitBtn').innerText = "æ›´æ–°è³‡æ–™"; document.getElementById('cancelBtn').style.display = 'block';
            switchView('add', document.querySelectorAll('.nav-item')[1]);
        }
        function resetForm() { form.reset(); document.getElementById('editId').value = ''; document.getElementById('pageTitle').innerText="æ–°å¢ç´€éŒ„"; document.getElementById('submitBtn').innerText="å„²å­˜ç´€éŒ„"; document.getElementById('cancelBtn').style.display='none'; toggleTransferFields(); currentImage=null; }
        function deleteItem(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { items = items.filter(i => i.id !== id); if(selectedIds.has(id)) selectedIds.delete(id); saveData(); renderList(); populateMonthFilter(); } }
        function toggleTransferFields() { document.getElementById('transferFields').style.display = document.getElementById('paymentType').value === 'Transfer' ? 'block' : 'none'; }
        function forceCloudSync() { if(confirm("å¼·åˆ¶ä¸Šå‚³ï¼Ÿ")) { const ind = document.getElementById('syncIndicator'); ind.className = 'sync-status loading'; fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(items) }).then(()=>{ showToast("å·²é€å‡º"); updateSyncStatus('ok'); }).catch(()=>{ showToast("å¤±æ•—", "error"); updateSyncStatus('error'); }); } }
        function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(items,null,2)],{type:'application/json'})); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function importData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload=e=>{ try{ items=JSON.parse(e.target.result); saveData(); populateMonthFilter(); renderList(); showToast("åŒ¯å…¥æˆåŠŸ"); }catch{ showToast("éŒ¯èª¤", "error"); } }; r.readAsText(f); }
        function clearAllData() { if(confirm('æ¸…ç©ºï¼Ÿ')) { items=[]; saveData(); populateMonthFilter(); renderList(); } }
        
        function downloadTemplate() { if(typeof XLSX==='undefined'){showToast('ç¶²è·¯éŒ¯èª¤', 'error');return;} const data=[{"å•†å“åç¨±":"ç¯„ä¾‹","åˆ†é¡":"å‘¨é‚Š","ä¸‹å–®æ—¥æœŸ":"2025-01-01","è³¼è²·ä¾†æº":"å®˜ç¶²","è³£å®¶åç¨±":"@abc","è³£å®¶é€£çµ":"","ä»˜æ¬¾æ–¹å¼ (å¾…ä»˜æ¬¾/è²¨åˆ°ä»˜æ¬¾/éŠ€è¡ŒåŒ¯æ¬¾)":"éŠ€è¡ŒåŒ¯æ¬¾","åŒ¯æ¬¾æ—¥æœŸ":"2025-01-01","åŒ¯æ¬¾é‡‘é¡":500,"å–®åƒ¹":500,"äºŒè£œ":0,"åœ‹å…§é‹è²»":60,"å¾…å‡ºè²¨æ—¥":"","å·²å‡ºè²¨æ—¥":"","å–è²¨æ—¥":"","ä¸‹å–®é€£çµ":"","å°å¸³è¡¨é€£çµ":"","å‚™è¨»":""}]; XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(data), "Sheet1")), "CORTIS_V22ç¯„æœ¬.xlsx"); }
        function importExcel(input) { if(typeof XLSX==='undefined'){showToast('ç¶²è·¯éŒ¯èª¤', 'error');input.value='';return;} const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(json.length===0)throw new Error("ç„¡è³‡æ–™"); const newItems=json.map(row=>{ let pType="Pending"; const pRaw=row["ä»˜æ¬¾æ–¹å¼ (å¾…ä»˜æ¬¾/è²¨åˆ°ä»˜æ¬¾/éŠ€è¡ŒåŒ¯æ¬¾)"]||""; if(pRaw.includes("è²¨åˆ°"))pType="COD"; else if(pRaw.includes("åŒ¯æ¬¾"))pType="Transfer"; return { id:Date.now()+Math.floor(Math.random()*100000), name:row["å•†å“åç¨±"]||"æœªå‘½å", category:row["åˆ†é¡"]||"å‘¨é‚Š", orderDate:row["ä¸‹å–®æ—¥æœŸ"]||new Date().toISOString().split('T')[0], source:row["è³¼è²·ä¾†æº"]||"", contact:row["è³£å®¶åç¨±"]||"", contactLink:row["è³£å®¶é€£çµ"]||"", paymentType:pType, transferDate:row["åŒ¯æ¬¾æ—¥æœŸ"]||"", transferAmount:Number(row["åŒ¯æ¬¾é‡‘é¡"])||0, price:Number(row["å–®åƒ¹"])||0, secondPay:Number(row["äºŒè£œ"])||0, shipping:Number(row["åœ‹å…§é‹è²»"])||0, link:row["ä¸‹å–®é€£çµ"]||"", reconcileLink:row["å°å¸³è¡¨é€£çµ"]||"", notes:row["å‚™è¨»"]||"", imageSrc:"", group:null, status:{notArrived:true, pendingShip:!!row["å¾…å‡ºè²¨æ—¥"], shipped:!!row["å·²å‡ºè²¨æ—¥"], pickedUp:!!row["å–è²¨æ—¥"]}, dates:{pendingShip:row["å¾…å‡ºè²¨æ—¥"]||'', shipped:row["å·²å‡ºè²¨æ—¥"]||'', pickedUp:row["å–è²¨æ—¥"]||''} }; }); items=[...newItems,...items]; saveData(); populateMonthFilter(); renderList(); showToast(`åŒ¯å…¥ ${newItems.length} ç­†`); }catch(err){showToast(err.message, "error");} finally{input.value='';} }; r.readAsArrayBuffer(f); }

        function togglePinSetting() {
            const isEnabled = document.getElementById('pinToggle').checked;
            const area = document.getElementById('pinChangeArea');
            appSettings.pinEnabled = isEnabled;
            if(isEnabled) { area.classList.remove('hidden'); if(!appSettings.pin) appSettings.pin="0000"; showToast(`å¯†ç¢¼å·²é–‹å•Ÿ`); } 
            else { area.classList.add('hidden'); }
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
        }
        function saveNewPin() {
            const newPin = document.getElementById('newPinInput').value;
            if(newPin.length !== 4 || isNaN(newPin)) { showToast("è«‹è¼¸å…¥4ä½æ•¸å­—", "error"); return; }
            appSettings.pin = newPin;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
            showToast("å¯†ç¢¼ä¿®æ”¹æˆåŠŸ");
            document.getElementById('newPinInput').value = '';
        }
    </script>
</body>
</html>
