<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CORTIS (V28 å¼·åˆ¶åŒæ­¥ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-color: #F0ECE6;
            --card-bg: #FFFFFF; 
            --text-main: #262626; --text-sub: #666666;
            --border: 1px solid #E0E0E0;
            --accent: #d63031; 
            --nav-height: 70px; --select-color: #27ae60;
            --radius: 12px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg-color); color: var(--text-main); 
            font-family: 'Noto Sans TC', 'Inter', sans-serif; margin: 0; padding: 0; 
            padding-bottom: calc(var(--nav-height) + 120px); min-height: 100vh; 
        }

        /* æç¤ºè¨Šæ¯ (Toast) */
        #toast-container { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 12000; display: flex; flex-direction: column; gap: 10px; width: auto; max-width: 90%; pointer-events: none; }
        .toast {
            pointer-events: auto; padding: 12px 24px; border-radius: 50px; background: #fff; color: #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); font-weight: bold; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 1px solid rgba(0,0,0,0.05); white-space: nowrap;
        }
        .toast i { font-style: normal; font-size: 16px; }
        .toast.success i { color: #27ae60; }
        .toast.error i { color: #d63031; }
        @keyframes slideDown { from { transform: translate(-50%, -30px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* åœ–ç‰‡æª¢è¦–å™¨ */
        #imageViewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 11000;
            display: none; justify-content: center; align-items: center;
        }
        #imageViewer img { max-width: 95%; max-height: 80%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .close-img-btn {
            position: absolute; top: 40px; right: 30px;
            background: rgba(255,255,255,0.2); color: #fff; 
            width: 44px; height: 44px; border-radius: 50%; font-size: 24px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3);
        }

        /* ç·¨è¼¯å½ˆçª— */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10500;
            display: none; justify-content: center; align-items: end;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #F0ECE6; width: 100%; max-width: 600px; height: 90%; 
            border-radius: 20px 20px 0 0; padding: 25px;
            overflow-y: auto; position: relative; animation: slideUp 0.3s ease-out;
        }
        @media (min-width: 768px) { .modal-overlay { align-items: center; } .modal-content { height: auto; max-height: 90%; border-radius: 12px; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.5rem; font-weight: 900; color: var(--text-main); }
        .close-modal { font-size: 28px; cursor: pointer; color: #999; padding: 5px; line-height: 1; }

        /* é–å®šç•«é¢ */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .pin-container { text-align: center; } .pin-title { font-size: 2rem; font-weight: 900; margin-bottom: 20px; }
        .pin-input { padding: 15px; font-size: 24px; text-align: center; letter-spacing: 10px; border: 2px solid var(--text-main); border-radius: 8px; width: 200px; background: #fff; outline: none; font-family: monospace; }

        /* é ‚éƒ¨å·¥å…· */
        .top-container {
            background: var(--bg-color); position: sticky; top: 0; z-index: 40;
            border-bottom: 1px solid rgba(0,0,0,0.05); padding: 15px; margin-bottom: 5px;
        }
        .search-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .search-box { flex: 1; position: relative; }
        .search-input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ccc; border-radius: 8px; background: #fff; font-size: 14px; height: 44px; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        .sort-btn { background: var(--text-main); color: #fff; border: none; padding: 0; width: 44px; border-radius: 8px; font-size: 16px; font-weight: bold; height: 44px; cursor: pointer; flex-shrink: 0; }
        .filter-row { display: flex; gap: 10px; align-items: center; }
        .filter-select { flex: 1; padding: 0 10px; border: 1px solid #ccc; border-radius: 8px; background: #fff; font-weight: bold; font-size: 13px; color: var(--text-main); height: 44px; text-align: left; }
        
        /* ç‹€æ…‹ç‡ˆ */
        .sync-box { width: 44px; height: 44px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; color: #fff; flex-shrink: 0; transition: background 0.3s; }
        .sync-box.ok { background: #2ecc71; }
        .sync-box.loading { background: #f1c40f; color: #000; animation: pulse 1s infinite; }
        .sync-box.error { background: #e74c3c; }

        .summary-bar { background: var(--text-main); padding: 10px 20px; font-size: 13px; color: #fff; display: flex; justify-content: space-between; align-items: center; margin: 0 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .summary-val { color: #fff; font-weight: 900; font-family: monospace; font-size: 16px; }

        .view-section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.2s ease; }
        #view-home { padding: 0; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        h2.page-title { font-size: 1.5rem; font-weight: 800; margin: 0 0 20px 0; padding-bottom: 10px; display: flex; align-items: center; gap: 15px; color: var(--text-main); }
        .back-btn { font-size: 18px; background: #fff; border: 1px solid #ccc; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-main); }

        .card-grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 15px; }
        @media (min-width: 768px) { .card-grid { grid-template-columns: repeat(3, 1fr); } } 
        
        .merch-card { background: var(--card-bg); border: 1px solid transparent; border-radius: var(--radius); box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden; display: flex; flex-direction: column; position: relative; transition: all 0.2s; }
        .merch-card.selected { border: 2px solid var(--select-color); }
        
        .card-select-overlay { position: absolute; top: 15px; right: 15px; z-index: 5; }
        .custom-checkbox { width: 24px; height: 24px; border: 2px solid #fff; background: rgba(0,0,0,0.3); backdrop-filter: blur(2px); border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .merch-card.selected .custom-checkbox { background: var(--select-color); border-color: var(--select-color); }
        
        .card-status-bar { height: 6px; background: #eee; width: 94%; margin: 3px auto 0; border-radius: 4px; display: flex; gap: 2px; overflow: hidden; }
        .status-segment { flex: 1; opacity: 0.2; background: var(--text-main); }
        .status-segment.active { opacity: 1; }
        
        .card-header { padding: 15px; display: flex; gap: 12px; border-bottom: 1px solid #f5f5f5; }
        .card-thumb { width: 70px; height: 70px; background: #f5f5f5; border-radius: 8px; object-fit: cover; flex-shrink: 0; border: 1px solid #eee; cursor: zoom-in; }
        .card-title-group { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; padding-right: 30px; }
        .category-tag { font-size: 10px; background: #f0f0f0; color: #666; padding: 2px 8px; border-radius: 12px; font-weight: 600; display: inline-block; margin-bottom: 4px; width: fit-content; }
        .group-tag { font-size: 10px; background: var(--text-main); color: #fff; padding: 2px 8px; border-radius: 12px; font-weight: 600; display: inline-block; margin-bottom: 4px; margin-right: 5px; width: fit-content; }
        .remove-group { cursor: pointer; margin-left: 5px; opacity: 0.7; }
        .card-title { font-size: 16px; font-weight: 800; margin: 0 0 3px 0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-subtitle { font-size: 12px; color: #888; }
        .contact-link { color: #000; text-decoration: underline; font-weight: bold; cursor: pointer; }
        
        .info-grid { padding: 12px 15px; display: grid; grid-template-columns: 80px 1fr; gap: 6px; font-size: 13px; align-items: baseline; }
        .label { color: #888; font-weight: 500; text-align-last: justify; }
        .value { font-weight: 600; text-align: right; font-family: 'Inter', monospace; color: #333; }
        .value.highlight { font-weight: 900; font-size: 15px; border-top: 1px dashed #eee; padding-top: 5px; margin-top: 5px; color: #000; }
        
        .note-toggle-btn { font-size: 12px; color: #555; background: #fcfcfc; border: 1px solid #f0f0f0; width: 100%; padding: 8px; text-align: center; cursor: pointer; border-left:none; border-right:none; }
        .note-content { display: none; padding: 10px 15px; background: #fffbe6; font-size: 12px; color: #555; white-space: pre-wrap; line-height: 1.4; }
        .note-content.show { display: block; }

        .checklist-col { padding: 10px 15px; background: #fff; border-top: 1px solid #f5f5f5; display: flex; flex-direction: column; gap: 8px; }
        .check-group { display: flex; align-items: center; justify-content: space-between; font-size: 13px; color: #666; height: 28px; }
        .check-left { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .check-box { width: 16px; height: 16px; border: 1px solid #ccc; border-radius: 4px; display: block; background: #fff; transition: all 0.2s; }
        .check-group.checked .check-box { background: var(--text-main); border-color: var(--text-main); }
        .check-group.checked .check-label { font-weight: bold; color: #000; }
        .mini-date { border: none; background: #f9f9f9; font-size: 12px; color: #333; border-radius: 4px; text-align: center; width: 110px; font-family: 'Inter', monospace; padding: 2px 5px; visibility: hidden; }
        .check-group.checked .mini-date { visibility: visible; }

        .seller-info { padding: 8px 15px; background: #fcfcfc; border-top: 1px solid #f5f5f5; font-size: 11px; color: #666; text-align: center; display: flex; justify-content: space-between; }
        .seller-link { color: #000; text-decoration: underline; cursor: pointer; }

        .card-actions { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; background: #fff; border-top: 1px solid #f5f5f5; }
        .action-btn { background: transparent; border: none; padding: 12px 0; font-size: 12px; font-weight: 600; border-right: 1px solid #f5f5f5; color: #555; cursor: pointer; }
        .action-btn:last-child { border: none; }
        .action-btn:active { background: #f9f9f9; }

        .form-container { background: var(--card-bg); padding: 25px; border: var(--border); border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-col { flex: 1; width: 50%; } 
        .form-group { margin-bottom: 18px; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 6px; color: #333; }
        input, select, textarea { width: 100%; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; background: #fcfcfc; font-size: 15px; color: var(--text-main); height: 44px; line-height: 44px; box-sizing: border-box; -webkit-appearance: none; appearance: none; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #666; outline: none; background: #fff; }
        textarea { height: 80px; line-height: 1.5; padding: 10px; }
        input[type="file"] { padding: 10px; line-height: 1.2; height: 44px; border: 1px dashed #ccc; }
        .btn-main { width: 100%; background: var(--text-main); color: #fff; padding: 15px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; letter-spacing: 1px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .image-group { display: flex; gap: 10px; }
        .del-img-btn { height: 44px; width: 44px; border: 1px solid #ccc; border-radius: 8px; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #d63031; font-weight: bold; }
        #transferFields { background: #f4f4f4; border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .info-input-grid { display: flex; gap: 10px; background: #f9f9f9; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .info-input-item { flex: 1; text-align: center; }
        .info-input-item label { font-size: 11px; color: #666; }
        .info-input-item input { text-align: right; background: #fff; }

        .settings-menu-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 18px; background: #fff; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; font-weight: 700; font-size: 15px; cursor: pointer; text-align: left; border-radius: 12px; color: #333; transition: transform 0.1s; }
        .section-header { font-size: 14px; color: #333; font-weight: 900; margin: 25px 0 10px 5px; }
        .clean-btn-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .clean-btn { background: #fff; border: 1px solid #ddd; color: var(--text-main); padding: 16px; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .clean-btn.danger { background: #FDE8E8; border-color: #F8B4B4; color: #C0392B; }
        
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #eee; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--text-main); }
        input:checked + .slider:before { transform: translateX(24px); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        .nav-item { flex: 1; text-align: center; color: #aaa; font-size: 10px; font-weight: 600; cursor: pointer; padding-top: 10px; transition: color 0.2s; }
        .nav-item.active { color: var(--text-main); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 3px; }

        /* æ‰¹é‡æ“ä½œåˆ— */
        .bulk-actions-bar { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(150px); background: var(--text-main); color: #fff; padding: 10px 20px; display: none; gap: 10px; align-items: center; border-radius: 50px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: transform 0.3s; z-index: 10100; white-space: nowrap; overflow-x: auto; max-width: 90%; }
        .bulk-actions-bar.active { display: flex; transform: translateX(-50%) translateY(0); }
        .bulk-btn { background: #fff; color: #000; border: none; padding: 5px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .bulk-btn.danger { background: var(--accent); color: #fff; }
        .bulk-btn.select-all { background: #f39c12; color: #fff; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="imageViewer">
        <div class="close-img-btn" onclick="document.getElementById('imageViewer').style.display='none'">Ã—</div>
        <img id="fullImage" src="">
    </div>

    <div id="toast-container"></div>

    <div id="lockScreen">
        <div class="pin-container">
            <div class="pin-title">LOCKED</div>
            <div class="pin-msg">è«‹è¼¸å…¥ PIN ç¢¼</div>
            <input type="password" id="pinInput" class="pin-input" maxlength="4" pattern="[0-9]*" inputmode="numeric">
        </div>
    </div>

    <!-- ç·¨è¼¯å½ˆçª— -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ç·¨è¼¯ç´€éŒ„</div>
                <div class="close-modal" onclick="closeEditModal()">Ã—</div>
            </div>
            <!-- ç·¨è¼¯è¡¨å–® -->
            <form id="editForm" onsubmit="handleEditSubmit(event)">
                <input type="hidden" name="editId">
                <div class="form-group"><label>å•†å“åç¨± <span style="color:red">*</span></label><input type="text" name="name" required></div>
                <div class="form-row">
                    <div class="form-col"><label>åˆ†é¡</label><select name="category"><option>å‘¨é‚Š</option><option>å°ˆè¼¯</option><option>å°å¡</option><option>ç¥¨å‹™</option><option>å…¶ä»–</option></select></div>
                    <div class="form-col"><label>è³¼è²·ä¾†æº</label><input type="text" name="source"></div>
                </div>
                <div class="form-group"><label>ä¸‹å–®æ—¥æœŸ <span style="color:red">*</span></label><input type="date" name="orderDate" required></div>
                <div class="form-group"><label>è³£å®¶è¯çµ¡è³‡è¨Š</label><div class="form-row" style="margin:0;"><div class="form-col"><input type="text" name="contact" placeholder="åç¨±"></div><div class="form-col"><input type="url" name="contactLink" placeholder="é€£çµ"></div></div></div>
                <div class="form-group"><label>ä»˜æ¬¾æ–¹å¼</label><select name="paymentType" onchange="toggleTransferFields(this)"><option value="Pending">å¾…ä»˜æ¬¾</option><option value="COD">è²¨åˆ°ä»˜æ¬¾</option><option value="Transfer">éŠ€è¡ŒåŒ¯æ¬¾</option></select></div>
                <div class="transferFields hidden" style="background:#f4f4f4; border:1px solid #eee; padding:15px; margin-bottom:15px; border-radius:8px;"><div class="form-row"><div class="form-col"><label>åŒ¯æ¬¾æ—¥æœŸ</label><input type="date" name="transferDate"></div><div class="form-col"><label>é‡‘é¡</label><input type="number" name="transferAmount"></div></div></div>
                <div class="form-group"><label>è²»ç”¨ (NT$)</label><div class="info-input-grid"><div class="info-input-item"><label>å–®åƒ¹</label><input type="number" name="price"></div><div class="info-input-item"><label>äºŒè£œ</label><input type="number" name="secondPay"></div><div class="info-input-item"><label>é‹è²»</label><input type="number" name="shipping"></div></div></div>
                <div class="form-group"><label>ç›¸é—œé€£çµ</label><div style="display:flex; flex-direction:column; gap:10px;"><input type="url" name="link" placeholder="ä¸‹å–®é€£çµ..."><input type="url" name="reconcileLink" placeholder="å°å¸³è¡¨é€£çµ..."></div></div>
                <div class="form-group"><label>å‚™è¨»</label><textarea name="notes" style="height:60px;"></textarea></div>
                <div class="form-group"><label>åœ–ç‰‡</label><div class="image-group"><input type="file" name="imageInput" accept="image/*" style="flex:1;"><button type="button" class="del-img-btn" onclick="clearEditImage()">ğŸ—‘</button></div></div>
                <button type="submit" class="btn-main">æ›´æ–°å„²å­˜</button>
            </form>
        </div>
    </div>

    <!-- åˆ—è¡¨é  -->
    <div id="view-home" class="view-section active">
        <div class="top-container">
            <div class="search-row">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å•†å“åç¨±..." oninput="renderList()">
                </div>
                <button class="sort-btn" onclick="toggleSort()">â‡…</button>
            </div>
            <div class="filter-row">
                <select id="monthFilter" class="filter-select" onchange="renderList()">
                    <option value="all">ğŸ“… æ‰€æœ‰æœˆä»½</option>
                </select>
                <select id="categoryFilter" class="filter-select" onchange="renderList()">
                    <option value="all">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>
                    <option value="å‘¨é‚Š">å‘¨é‚Š</option>
                    <option value="å°ˆè¼¯">å°ˆè¼¯</option>
                    <option value="å°å¡">å°å¡</option>
                    <option value="ç¥¨å‹™">ç¥¨å‹™</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <div id="syncWrapper" class="sync-box ok">å¾…å‘½</div>
            </div>
        </div>

        <div class="summary-bar">
            <span>ç•¶å‰èŠ±è²»</span>
            <span class="summary-val" id="summaryTotal">NT$ 0</span>
            <span style="font-size:12px; margin-left:10px;">( <span id="summaryCount">0</span> ç­† )</span>
        </div>

        <div id="merchGrid" class="card-grid" style="margin-top:15px;"></div>
        <div id="emptyState" style="text-align:center; padding:50px; color:#999; display:none;">ç›®å‰æ²’æœ‰ç´€éŒ„</div>
    </div>

    <!-- æ–°å¢é  -->
    <div id="view-add" class="view-section">
        <div class="form-container">
            <form id="addForm" onsubmit="handleAddSubmit(event)">
                <div class="form-group"><label>å•†å“åç¨± <span style="color:red">*</span></label><input type="text" name="name" required></div>
                <div class="form-row">
                    <div class="form-col"><label>åˆ†é¡</label><select name="category"><option>å‘¨é‚Š</option><option>å°ˆè¼¯</option><option>å°å¡</option><option>ç¥¨å‹™</option><option>å…¶ä»–</option></select></div>
                    <div class="form-col"><label>è³¼è²·ä¾†æº</label><input type="text" name="source" placeholder="ä¾‹: å®˜ç¶²"></div>
                </div>
                <div class="form-group"><label>ä¸‹å–®æ—¥æœŸ <span style="color:red">*</span></label><input type="date" name="orderDate" required></div>
                <div class="form-group"><label>è³£å®¶è¯çµ¡è³‡è¨Š</label><div class="form-row" style="margin-bottom:0;"><div class="form-col"><input type="text" name="contact" placeholder="åç¨±"></div><div class="form-col"><input type="url" name="contactLink" placeholder="é€£çµ"></div></div></div>
                <div class="form-group"><label>ä»˜æ¬¾æ–¹å¼</label><select name="paymentType" onchange="toggleTransferFields(this)"><option value="Pending">å¾…ä»˜æ¬¾</option><option value="COD">è²¨åˆ°ä»˜æ¬¾</option><option value="Transfer">éŠ€è¡ŒåŒ¯æ¬¾</option></select></div>
                <div class="transferFields hidden" style="background:#f4f4f4; border:1px solid #eee; padding:15px; margin-bottom:15px; border-radius:8px;"><div class="form-row"><div class="form-col"><label>åŒ¯æ¬¾æ—¥æœŸ</label><input type="date" name="transferDate"></div><div class="form-col"><label>é‡‘é¡</label><input type="number" name="transferAmount"></div></div></div>
                <div class="form-group"><label>è²»ç”¨ (NT$)</label><div class="info-input-grid"><div class="info-input-item"><label>å–®åƒ¹</label><input type="number" name="price"></div><div class="info-input-item"><label>äºŒè£œ</label><input type="number" name="secondPay"></div><div class="info-input-item"><label>é‹è²»</label><input type="number" name="shipping"></div></div></div>
                <div class="form-group"><label>é€£çµ</label><div style="display:flex; flex-direction:column; gap:10px;"><input type="url" name="link" placeholder="ä¸‹å–®é€£çµ..."><input type="url" name="reconcileLink" placeholder="å°å¸³è¡¨é€£çµ..."></div></div>
                <div class="form-group"><label>å‚™è¨»</label><textarea name="notes" style="height:60px;"></textarea></div>
                <div class="form-group"><label>åœ–ç‰‡</label><div class="image-group"><input type="file" name="imageInput" accept="image/*" style="flex:1;"><button type="button" class="del-img-btn" onclick="clearAddImage()">ğŸ—‘</button></div></div>
                <button type="submit" class="btn-main">å„²å­˜</button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†é  -->
    <div id="view-settings" class="view-section">
        <h2 class="page-title">ç®¡ç†</h2>
        <button class="settings-menu-btn" onclick="openSubPage('data')">ğŸ“‚ è³‡æ–™åŒ¯å…¥ / å‚™ä»½</button>
        <button class="settings-menu-btn" onclick="openSubPage('security')">ğŸ”’ å®‰å…¨æ€§è¨­å®š</button>
    </div>

    <!-- è³‡æ–™åŒ¯å…¥/å‚™ä»½ å­é é¢ -->
    <div id="view-settings-data" class="view-section">
        <h2 class="page-title"><button class="back-btn" onclick="openSubPage('main')">â†</button> è³‡æ–™ç®¡ç†</h2>
        
        <div class="section-header">Excel æ•´åˆ</div>
        <div class="clean-btn-group">
            <button class="clean-btn" onclick="downloadTemplate()">ğŸ“Š ä¸‹è¼‰ Excel ç¯„æœ¬ <span>â€º</span></button>
            <div style="position:relative;">
                <button class="clean-btn" style="width:100%" onclick="document.getElementById('excelInput').click()">ğŸ“¥ åŒ¯å…¥ Excel æª”æ¡ˆ <span>â€º</span></button>
                <input type="file" id="excelInput" onchange="importExcel(this)" accept=".xlsx, .xls, .csv" style="display:none;">
            </div>
        </div>

        <div class="section-header">ç³»çµ±å‚™ä»½</div>
        <div class="clean-btn-group">
            <button class="clean-btn" onclick="exportData()">â¬‡ ä¸‹è¼‰ JSON å‚™ä»½ <span>â€º</span></button>
            <div style="position:relative;">
                <button class="clean-btn" style="width:100%" onclick="document.getElementById('jsonInput').click()">â¬† åŒ¯å…¥ JSON å‚™ä»½ <span>â€º</span></button>
                <input type="file" id="jsonInput" onchange="importData(this)" accept=".json" style="display:none;">
            </div>
        </div>

        <div class="section-header">é›²ç«¯èˆ‡é‡ç½®</div>
        <div class="clean-btn-group">
            <button class="clean-btn" onclick="uploadToCloud()">â¬† ä¸Šå‚³è‡³é›²ç«¯ <span>â€º</span></button>
            <button class="clean-btn" onclick="downloadFromCloud()">â¬‡ å¾é›²ç«¯é‚„åŸ <span>â€º</span></button>
            <button class="clean-btn danger" onclick="clearAllData()">âš  æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

    <!-- å®‰å…¨æ€§ å­é é¢ -->
    <div id="view-settings-security" class="view-section">
        <h2 class="page-title"><button class="back-btn" onclick="openSubPage('main')">â†</button> å®‰å…¨æ€§</h2>
        <div class="settings-card" style="background:#fff; padding:20px; border-radius:12px; border:1px solid #eee;">
            <div class="toggle-switch">
                <span>å•Ÿç”¨ PIN ç¢¼é–å®š</span>
                <label class="switch"><input type="checkbox" id="pinToggle" onchange="togglePinSetting()"><span class="slider"></span></label>
            </div>
            <div id="pinChangeArea" class="hidden" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <input type="number" id="newPinInput" placeholder="è¼¸å…¥æ–° PIN (4ç¢¼)" style="margin-bottom:10px;" maxlength="4">
                <button class="btn-main" onclick="saveNewPin()">å„²å­˜æ–°å¯†ç¢¼</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œåˆ— -->
    <div id="bulkActions" class="bulk-actions-bar">
        <div style="font-size:12px;">å·²é¸ <span id="selectedCount">0</span> ç­†</div>
        <button class="bulk-btn select-all" onclick="selectAllVisible()">âœ… å…¨é¸</button>
        <button class="bulk-btn" onclick="mergeSelectedItems()">ğŸ”— åˆä½µ</button>
        <button class="bulk-btn danger" onclick="deleteSelectedItems()">ğŸ—‘ åˆªé™¤</button>
        <button class="bulk-btn" onclick="clearSelection()" style="background:#666; color:#fff;">å–æ¶ˆ</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchView('home', this)"><span class="nav-icon">â˜°</span>åˆ—è¡¨</div>
        <div class="nav-item" onclick="switchView('add', this)"><span class="nav-icon">ï¼‹</span>æ–°å¢</div>
        <div class="nav-item" onclick="switchView('settings', this)"><span class="nav-icon">âš™</span>ç®¡ç†</div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyeGblocTD-g8e3yUbG0YSMBRbT-6Uwfu2gF09Bjgqt32C_GIjBwnl-Ni2-cfDwXQfl4g/exec";
        const STORAGE_KEY = 'cortis_v26_data';
        const SETTINGS_KEY = 'cortis_v26_settings';
        
        let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let appSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { pinEnabled: false, pin: "0000" };
        
        let sortDesc = true;
        let selectedIds = new Set();
        let isSyncing = false;
        let editImageTemp = null;

        const views = { 
            home: document.getElementById('view-home'), 
            add: document.getElementById('view-add'), 
            settings: document.getElementById('view-settings'),
            settingsData: document.getElementById('view-settings-data'),
            settingsSecurity: document.getElementById('view-settings-security')
        };
        const STATUS_KEYS = ['notArrived', 'pendingShip', 'shipped', 'pickedUp'];
        const STATUS_LABELS = { notArrived:'æœªåˆ°è²¨', pendingShip:'å¾…å‡ºè²¨', shipped:'å·²å‡ºè²¨', pickedUp:'å–è²¨' };
        const PAYMENT_LABELS = { Pending:'å¾…ä»˜æ¬¾', COD:'è²¨åˆ°ä»˜æ¬¾', Transfer:'éŠ€è¡ŒåŒ¯æ¬¾' };

        window.onload = () => {
            document.getElementById('pinToggle').checked = appSettings.pinEnabled;
            if(appSettings.pinEnabled) {
                document.getElementById('lockScreen').style.display = 'flex';
                document.getElementById('pinInput').addEventListener('input', checkPin);
                document.getElementById('pinInput').focus();
            } else { initApp(); }
        };

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            container.innerHTML = '';
            const toast = document.createElement('div');
            const icon = type === 'success' ? '<i>âœ…</i>' : '<i>âŒ</i>';
            toast.className = `toast ${type}`;
            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        function checkPin(e) {
            if (e.target.value === appSettings.pin) {
                document.getElementById('lockScreen').style.display = 'none';
                initApp();
            }
        }

        function initApp() {
            renderList(); populateMonthFilter();
            document.querySelector('#addForm [name="orderDate"]').valueAsDate = new Date();
            updateSyncStatus('ready');
            syncWithCloud();
        }

        // --- å¼·åˆ¶ç¶å®šå‡½å¼åˆ° window ---
        
        window.showImage = function(src) {
            if(!src) return;
            document.getElementById('fullImage').src = src;
            document.getElementById('imageViewer').style.display = 'flex';
        };

        window.toggleSort = function() { sortDesc = !sortDesc; renderList(); };
        window.clearAddImage = function() { document.querySelector('#addForm [name="imageInput"]').value = ''; };
        window.clearEditImage = function() { document.querySelector('#editForm [name="imageInput"]').value = ''; editImageTemp = ''; };
        
        window.toggleTransferFields = function(select) { 
            const form = select.closest('form');
            const div = form.querySelector('.transferFields');
            if (select.value === 'Transfer') div.classList.remove('hidden'); 
            else div.classList.add('hidden'); 
        };

        window.handleAddSubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button[type="submit"]');
            if (btn.disabled) return;
            btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;

            const name = form.querySelector('[name="name"]').value;
            const orderDate = form.querySelector('[name="orderDate"]').value;

            if(!name || !orderDate) {
                showToast("è«‹å¡«å¯«å•†å“åç¨±èˆ‡ä¸‹å–®æ—¥æœŸ", "error"); 
                btn.innerText = "å„²å­˜"; btn.disabled = false; return;
            }

            try {
                const imgInput = form.querySelector('[name="imageInput"]');
                let imgData = "";
                if(imgInput.files && imgInput.files[0]) {
                    imgData = await compressImage(imgInput.files[0]);
                }

                const newItem = {
                    id: String(Date.now()), 
                    name: name,
                    category: form.querySelector('[name="category"]').value,
                    orderDate: orderDate,
                    source: form.querySelector('[name="source"]').value,
                    contact: form.querySelector('[name="contact"]').value,
                    contactLink: form.querySelector('[name="contactLink"]').value,
                    paymentType: form.querySelector('[name="paymentType"]').value,
                    transferDate: form.querySelector('[name="transferDate"]').value,
                    transferAmount: Number(form.querySelector('[name="transferAmount"]').value),
                    price: Number(form.querySelector('[name="price"]').value),
                    secondPay: Number(form.querySelector('[name="secondPay"]').value),
                    shipping: Number(form.querySelector('[name="shipping"]').value),
                    link: form.querySelector('[name="link"]').value,
                    reconcileLink: form.querySelector('[name="reconcileLink"]').value,
                    notes: form.querySelector('[name="notes"]').value,
                    imageSrc: imgData,
                    group: null, 
                    status: {notArrived:true, pendingShip:false, shipped:false, pickedUp:false},
                    dates: {pendingShip:'', shipped:'', pickedUp:''},
                    refund: { isRefunded: false } 
                };

                items.unshift(newItem);
                saveData(); 
                form.reset();
                document.querySelector('#addForm [name="orderDate"]').valueAsDate = new Date();
                populateMonthFilter();
                switchView('home', document.querySelectorAll('.nav-item')[0]);
                showToast("æ–°å¢æˆåŠŸï¼");
                
            } catch (error) { 
                showToast("éŒ¯èª¤: " + error.message, "error"); 
            } finally { 
                btn.innerText = "å„²å­˜"; btn.disabled = false; 
            }
        };

        window.handleEditSubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('[name="editId"]').value;
            const idx = items.findIndex(i => String(i.id) === String(id));
            
            if(idx === -1) { showToast("æ‰¾ä¸åˆ°è³‡æ–™", "error"); return; }

            const imgInput = form.querySelector('[name="imageInput"]');
            let imgData = editImageTemp; 
            
            if(imgInput.files && imgInput.files[0]) {
                imgData = await compressImage(imgInput.files[0]);
            } else if (imgInput.value === '' && !editImageTemp) {
                imgData = ''; 
            }

            items[idx] = {
                ...items[idx],
                name: form.querySelector('[name="name"]').value,
                category: form.querySelector('[name="category"]').value,
                orderDate: form.querySelector('[name="orderDate"]').value,
                source: form.querySelector('[name="source"]').value,
                contact: form.querySelector('[name="contact"]').value,
                contactLink: form.querySelector('[name="contactLink"]').value,
                paymentType: form.querySelector('[name="paymentType"]').value,
                transferDate: form.querySelector('[name="transferDate"]').value,
                transferAmount: Number(form.querySelector('[name="transferAmount"]').value),
                price: Number(form.querySelector('[name="price"]').value),
                secondPay: Number(form.querySelector('[name="secondPay"]').value),
                shipping: Number(form.querySelector('[name="shipping"]').value),
                link: form.querySelector('[name="link"]').value,
                reconcileLink: form.querySelector('[name="reconcileLink"]').value,
                notes: form.querySelector('[name="notes"]').value,
                imageSrc: imgData
            };

            saveData();
            closeEditModal();
            renderList();
            showToast("ä¿®æ”¹æˆåŠŸï¼");
        };

        window.openEditModal = function(id) {
            const item = items.find(i => String(i.id) === String(id));
            if (!item) return;
            
            const form = document.getElementById('editForm');
            form.querySelector('[name="editId"]').value = item.id;
            form.querySelector('[name="name"]').value = item.name;
            form.querySelector('[name="category"]').value = item.category;
            form.querySelector('[name="source"]').value = item.source || '';
            form.querySelector('[name="orderDate"]').value = item.orderDate;
            form.querySelector('[name="contact"]').value = item.contact || '';
            form.querySelector('[name="contactLink"]').value = item.contactLink || '';
            form.querySelector('[name="paymentType"]').value = item.paymentType;
            form.querySelector('[name="transferDate"]').value = item.transferDate || '';
            form.querySelector('[name="transferAmount"]').value = item.transferAmount || '';
            form.querySelector('[name="price"]').value = item.price || '';
            form.querySelector('[name="secondPay"]').value = item.secondPay || '';
            form.querySelector('[name="shipping"]').value = item.shipping || '';
            form.querySelector('[name="link"]').value = item.link || '';
            form.querySelector('[name="reconcileLink"]').value = item.reconcileLink || '';
            form.querySelector('[name="notes"]').value = item.notes || '';
            
            editImageTemp = item.imageSrc; 
            
            const transferDiv = form.querySelector('.transferFields');
            if (item.paymentType === 'Transfer') transferDiv.classList.remove('hidden');
            else transferDiv.classList.add('hidden');
            
            document.getElementById('editModal').classList.add('active');
        };

        window.closeEditModal = function() {
            document.getElementById('editModal').classList.remove('active');
            editImageTemp = null;
        };

        window.toggleSelection = function(id) { 
            id = String(id);
            if(selectedIds.has(id)) selectedIds.delete(id); 
            else selectedIds.add(id); 
            renderList(); 
        };

        window.toggleStatus = function(id, key) {
            const item = items.find(i => String(i.id) === String(id));
            if(item) {
                const newStatus = !item.status[key];
                item.status[key] = newStatus;
                
                if(newStatus && ['pendingShip', 'shipped', 'pickedUp'].includes(key)) {
                    if(!item.dates) item.dates = {};
                    if(!item.dates[key]) item.dates[key] = new Date().toISOString().split('T')[0];
                } else if (!newStatus) {
                    if(item.dates) item.dates[key] = '';
                }
                saveData(); renderList();
            }
        };

        window.updateStatusDate = function(id, key, dateValue) {
            const item = items.find(i => String(i.id) === String(id));
            if(item) {
                if(!item.dates) item.dates = {};
                item.dates[key] = dateValue;
                if(dateValue && !item.status[key]) item.status[key] = true;
                saveData();
            }
        };

        window.deleteItem = function(id) { 
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) { 
                items = items.filter(i => String(i.id) !== String(id)); 
                if(selectedIds.has(String(id))) selectedIds.delete(String(id)); 
                saveData(); renderList(); populateMonthFilter(); 
            } 
        };

        window.deleteSelectedItems = function() { 
            if(confirm(`ç¢ºå®šåˆªé™¤é¸å–çš„ ${selectedIds.size} ç­†è³‡æ–™ï¼Ÿ`)) { 
                items = items.filter(i => !selectedIds.has(String(i.id))); 
                selectedIds.clear(); 
                saveData(); renderList(); populateMonthFilter(); 
            } 
        };

        window.mergeSelectedItems = function() { 
            const name = prompt("è¼¸å…¥ä½µå–®åç¨±:"); 
            if(name) { 
                items.forEach(i => { if(selectedIds.has(String(i.id))) i.group = name; }); 
                selectedIds.clear(); 
                saveData(); renderList(); 
            } 
        };

        window.selectAllVisible = function() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const monthVal = document.getElementById('monthFilter').value;
            const catVal = document.getElementById('categoryFilter').value;
            const filtered = items.filter(i => {
                const matchK = (i.name||'').toLowerCase().includes(keyword);
                const matchM = monthVal === 'all' || i.orderDate.startsWith(monthVal);
                const matchC = catVal === 'all' || i.category === catVal;
                return matchK && matchM && matchC;
            });
            filtered.forEach(i => selectedIds.add(String(i.id)));
            renderList();
        };

        window.clearSelection = function() { selectedIds.clear(); renderList(); };
        window.ungroupItem = function(id) { if(confirm("ç§»é™¤ä½µå–®ï¼Ÿ")) { const i = items.find(x => String(x.id) === String(id)); if(i) { i.group = null; saveData(); renderList(); } } };

        function updateSyncStatus(status) {
            const box = document.getElementById('syncWrapper');
            box.className = 'sync-box ' + status;
            if(status === 'ok') box.innerText = 'å·²åŒæ­¥';
            else if(status === 'loading') box.innerText = 'åŒæ­¥ä¸­';
            else if(status === 'error') box.innerText = 'å¤±æ•—';
            else box.innerText = 'å¾…å‘½';
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); updateSummary();
                // é›²ç«¯åŒæ­¥ (å¦‚æœå¤±æ•—ä¸æç¤ºï¼Œåƒ…æœ¬åœ°å­˜æª”)
                fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(items) });
            } catch (e) { showToast("å„²å­˜ç©ºé–“ä¸è¶³", "error"); }
        }

        // --- ä»‹é¢é‚è¼¯ ---
        window.switchView = function(view, el) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            views[view].classList.add('active'); 
            if(el) el.classList.add('active');
            
            if(view === 'home') { renderList(); updateBulkBar(); }
            else { document.getElementById('bulkActions').classList.remove('active'); }
            window.scrollTo(0,0);
        };

        window.renderList = function() {
            const grid = document.getElementById('merchGrid'); grid.innerHTML = '';
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const monthVal = document.getElementById('monthFilter').value;
            const catVal = document.getElementById('categoryFilter').value;

            let filtered = items.filter(i => {
                const matchK = (i.name||'').toLowerCase().includes(keyword);
                const matchM = monthVal === 'all' || i.orderDate.startsWith(monthVal);
                const matchC = catVal === 'all' || i.category === catVal;
                return matchK && matchM && matchC;
            });

            filtered.sort((a,b) => sortDesc ? new Date(b.orderDate)-new Date(a.orderDate) : new Date(a.orderDate)-new Date(b.orderDate));
            document.getElementById('emptyState').style.display = filtered.length ? 'none' : 'block';
            updateSummary(filtered);

            filtered.forEach(item => {
                const total = (item.price||0) + (item.secondPay||0) + (item.shipping||0);
                
                let checksHtml = '';
                STATUS_KEYS.forEach(k => {
                    const checked = item.status[k] ? 'checked' : '';
                    const dateVal = (item.dates && item.dates[k]) ? item.dates[k] : '';
                    let dateInputHtml = '';
                    if (['pendingShip', 'shipped', 'pickedUp'].includes(k)) {
                        const style = checked ? '' : 'visibility:hidden; height:0;';
                        dateInputHtml = `<input type="date" class="mini-date" value="${dateVal}" style="${style}" onchange="updateStatusDate('${item.id}', '${k}', this.value)" onclick="event.stopPropagation()">`;
                    }
                    checksHtml += `
                        <div class="check-group ${checked}">
                            <div class="check-left" onclick="toggleStatus('${item.id}', '${k}')">
                                <div class="check-box"></div>
                                <span class="check-label">${STATUS_LABELS[k]}</span>
                            </div>
                            ${dateInputHtml}
                        </div>`;
                });

                let contactDisplay = item.contact || '-';
                if(item.contactLink) contactDisplay = `<a class="contact-link" onclick="window.open('${item.contactLink}', '_blank')">${item.contact || 'é€£çµ'}</a>`;
                let groupHtml = item.group ? `<span class="group-tag">ğŸ“¦ ${item.group} <span class="remove-group" onclick="ungroupItem('${item.id}')">Ã—</span></span>` : '';
                
                const isSelected = selectedIds.has(String(item.id)) ? 'selected' : '';
                const checkMark = selectedIds.has(String(item.id)) ? '' : ''; // ç„¡å‹¾å‹¾
                const openUrl = (url) => url ? `window.open('${url}','_blank')` : '';
                const btnStyle = (url) => url ? '' : 'color:#ccc; cursor:default;';

                const noteBtnText = item.notes ? "æŸ¥çœ‹å‚™è¨»" : "ç„¡å‚™è¨»";
                const noteBtnColor = item.notes ? "#333" : "#999";
                const noteContent = item.notes || "ç„¡å…§å®¹";
                
                let payText = PAYMENT_LABELS[item.paymentType] || item.paymentType;
                if(item.paymentType === 'Transfer' && item.transferDate) {
                    payText += ` (${item.transferDate})`;
                }

                const card = document.createElement('div');
                card.className = `merch-card ${isSelected}`;
                const imgClick = item.imageSrc ? `onclick="showImage('${item.imageSrc}'); event.stopPropagation();"` : '';
                const imgHtml = item.imageSrc ? `<img src="${item.imageSrc}" class="card-thumb" ${imgClick}>` : `<div class="card-thumb"></div>`;

                card.innerHTML = `
                    <div class="card-select-overlay" onclick="toggleSelection('${item.id}'); event.stopPropagation();"><div class="custom-checkbox">${checkMark}</div></div>
                    <div class="card-status-bar">${STATUS_KEYS.map(k => `<div class="status-segment ${item.status[k]?'active':''}"></div>`).join('')}</div>
                    <div class="card-header">${imgHtml}
                        <div class="card-title-group"><div>${groupHtml}<span class="category-tag">${item.category||'å‘¨é‚Š'}</span></div><div class="card-title">${item.name}</div><div class="card-subtitle">${item.orderDate} Â· ${item.source||''}</div></div>
                    </div>
                    <div class="info-grid">
                        <span class="label">ä»˜æ¬¾æ–¹å¼</span><span class="value" style="font-size:13px;">${payText}</span>
                        <span class="label">å–®åƒ¹</span><span class="value">${item.price||0}</span>
                        <span class="label">äºŒè£œ</span><span class="value">${item.secondPay||0}</span>
                        <span class="label">åœ‹å…§é‹è²»</span><span class="value">${item.shipping||0}</span>
                        <span class="label" style="font-weight:900; color:#000;">ç¸½è¨ˆ</span><span class="value highlight">NT$ ${total}</span>
                    </div>
                    
                    <button class="note-toggle-btn" style="color:${noteBtnColor}" onclick="toggleNote(this)">${noteBtnText}</button>
                    <div class="note-content">${noteContent}</div>
                    
                    <div class="checklist-col">${checksHtml}</div>
                    
                    <div class="seller-info"><span>è³£å®¶è³‡è¨Š</span><span>${contactDisplay}</span></div>

                    <div class="card-actions">
                        <button class="action-btn" onclick="openEditModal('${item.id}')">ç·¨è¼¯</button>
                        <button class="action-btn" onclick="${openUrl(item.link)}" style="${btnStyle(item.link)}">ä¸‹å–®é€£çµ</button>
                        <button class="action-btn" onclick="${openUrl(item.reconcileLink)}" style="${btnStyle(item.reconcileLink)}">å°å¸³è¡¨</button>
                        <button class="action-btn text-red" onclick="deleteItem('${item.id}')">åˆªé™¤</button>
                    </div>`;
                grid.appendChild(card);
            });
            updateBulkBar();
        };

        function updateBulkBar() { 
            const bar = document.getElementById('bulkActions'); 
            const isHome = document.getElementById('view-home').classList.contains('active');
            if(selectedIds.size > 0 && isHome) { 
                bar.classList.add('active'); 
                document.getElementById('selectedCount').innerText = selectedIds.size; 
            } else { bar.classList.remove('active'); } 
        }

        window.toggleNote = function(btn) {
            const content = btn.nextElementSibling;
            if(content.innerText === "ç„¡å…§å®¹") return;
            content.classList.toggle('show');
            btn.innerHTML = content.classList.contains('show') ? "éš±è—å‚™è¨»" : "æŸ¥çœ‹å‚™è¨»";
        };

        function updateSummary(filteredItems = items) {
            const total = filteredItems.reduce((acc, i) => acc + (i.price||0) + (i.secondPay||0) + (i.shipping||0), 0);
            document.getElementById('summaryTotal').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('summaryCount').innerText = filteredItems.length;
        }

        function populateMonthFilter() {
            const select = document.getElementById('monthFilter');
            const currentVal = select.value;
            const months = [...new Set(items.map(i => i.orderDate.substring(0, 7)))].sort().reverse();
            let html = '<option value="all">ğŸ“… æ‰€æœ‰æœˆä»½</option>';
            months.forEach(m => { const [y, mm] = m.split('-'); html += `<option value="${m}">${y}å¹´ ${mm}æœˆ</option>`; });
            select.innerHTML = html;
            if(months.includes(currentVal)) select.value = currentVal; else select.value = "all";
        }

        window.openSubPage = function(page) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            if(page === 'main') views.settings.classList.add('active');
            else if(page === 'data') views.settingsData.classList.add('active');
            else if(page === 'security') views.settingsSecurity.classList.add('active');
            document.getElementById('bulkActions').classList.remove('active');
            window.scrollTo(0,0);
        };

        window.uploadToCloud = function() { 
            showToast("æ­£åœ¨ä¸Šå‚³...", "loading");
            fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(items) })
            .then(()=>{ showToast("âœ… ä¸Šå‚³æˆåŠŸï¼"); updateSyncStatus('ok'); })
            .catch(()=>{ showToast("âŒ ä¸Šå‚³å¤±æ•—", "error"); updateSyncStatus('error'); }); 
        };

        window.downloadFromCloud = function() {
            showToast("æ­£åœ¨ä¸‹è¼‰...", "loading");
            fetch(API_URL)
            .then(res => res.json())
            .then(cloudData => {
                if(Array.isArray(cloudData) && cloudData.length > 0) {
                    items = cloudData;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                    renderList(); populateMonthFilter();
                    showToast("âœ… è³‡æ–™å·²é‚„åŸï¼");
                    updateSyncStatus('ok');
                } else {
                    showToast("âŒ é›²ç«¯ç„¡è³‡æ–™", "error");
                }
            })
            .catch(e => { showToast("âŒ ä¸‹è¼‰å¤±æ•—", "error"); updateSyncStatus('error'); });
        };
        
        async function syncWithCloud() {
            if(isSyncing) return; isSyncing = true; updateSyncStatus('loading');
            try {
                const res = await fetch(API_URL); const cloudData = await res.json();
                if(Array.isArray(cloudData) && cloudData.length >= items.length) {
                    items = cloudData; localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                    renderList(); populateMonthFilter();
                }
                updateSyncStatus('ok');
            } catch(e) { updateSyncStatus('error'); } finally { isSyncing = false; }
        }

        // Excel åŠŸèƒ½
        window.downloadTemplate = function() { 
            if(typeof XLSX==='undefined'){showToast('ç¶²è·¯éŒ¯èª¤: Excelå·¥å…·æœªè¼‰å…¥', 'error');return;} 
            const data=[{"å•†å“åç¨±":"ç¯„ä¾‹","åˆ†é¡":"å‘¨é‚Š","ä¸‹å–®æ—¥æœŸ":"2025-01-01","è³¼è²·ä¾†æº":"å®˜ç¶²","è³£å®¶åç¨±":"@abc","è³£å®¶é€£çµ":"","ä»˜æ¬¾æ–¹å¼ (å¾…ä»˜æ¬¾/è²¨åˆ°ä»˜æ¬¾/éŠ€è¡ŒåŒ¯æ¬¾)":"éŠ€è¡ŒåŒ¯æ¬¾","åŒ¯æ¬¾æ—¥æœŸ":"2025-01-01","åŒ¯æ¬¾é‡‘é¡":500,"å–®åƒ¹":500,"äºŒè£œ":0,"åœ‹å…§é‹è²»":60,"å¾…å‡ºè²¨æ—¥":"","å·²å‡ºè²¨æ—¥":"","å–è²¨æ—¥":"","ä¸‹å–®é€£çµ":"","å°å¸³è¡¨é€£çµ":"","å‚™è¨»":""}]; 
            XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(data), "Sheet1")), "CORTIS_V24ç¯„æœ¬.xlsx"); 
        };

        window.exportData = function() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(items,null,2)],{type:'application/json'})); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
        
        window.importData = function(input) { 
            const f = input.files[0]; if(!f) return; 
            const r = new FileReader(); 
            r.onload=e=>{ try{ items=JSON.parse(e.target.result); saveData(); populateMonthFilter(); renderList(); showToast("âœ… JSON åŒ¯å…¥æˆåŠŸï¼"); }catch{ showToast("âŒ æ ¼å¼éŒ¯èª¤", "error"); } }; 
            r.readAsText(f); 
        };
        
        window.clearAllData = function() { if(confirm('æ¸…ç©ºï¼Ÿ')) { items=[]; saveData(); populateMonthFilter(); renderList(); } };

        window.importExcel = function(input) { 
            if(typeof XLSX==='undefined'){showToast('ç¶²è·¯éŒ¯èª¤', 'error');input.value='';return;} 
            const f=input.files[0]; if(!f)return; 
            const r=new FileReader(); r.onload=e=>{ try{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(json.length===0)throw new Error("ç„¡è³‡æ–™"); const newItems=json.map(row=>{ let pType="Pending"; const pRaw=row["ä»˜æ¬¾æ–¹å¼ (å¾…ä»˜æ¬¾/è²¨åˆ°ä»˜æ¬¾/éŠ€è¡ŒåŒ¯æ¬¾)"]||""; if(pRaw.includes("è²¨åˆ°"))pType="COD"; else if(pRaw.includes("åŒ¯æ¬¾"))pType="Transfer"; return { id:String(Date.now()+Math.floor(Math.random()*100000)), name:row["å•†å“åç¨±"]||"æœªå‘½å", category:row["åˆ†é¡"]||"å‘¨é‚Š", orderDate:row["ä¸‹å–®æ—¥æœŸ"]||new Date().toISOString().split('T')[0], source:row["è³¼è²·ä¾†æº"]||"", contact:row["è³£å®¶åç¨±"]||"", contactLink:row["è³£å®¶é€£çµ"]||"", paymentType:pType, transferDate:row["åŒ¯æ¬¾æ—¥æœŸ"]||"", transferAmount:Number(row["åŒ¯æ¬¾é‡‘é¡"])||0, price:Number(row["å–®åƒ¹"])||0, secondPay:Number(row["äºŒè£œ"])||0, shipping:Number(row["åœ‹å…§é‹è²»"])||0, link:row["ä¸‹å–®é€£çµ"]||"", reconcileLink:row["å°å¸³è¡¨é€£çµ"]||"", notes:row["å‚™è¨»"]||"", imageSrc:"", group:null, status:{notArrived:true, pendingShip:!!row["å¾…å‡ºè²¨æ—¥"], shipped:!!row["å·²å‡ºè²¨æ—¥"], pickedUp:!!row["å–è²¨æ—¥"]}, dates:{pendingShip:row["å¾…å‡ºè²¨æ—¥"]||'', shipped:row["å·²å‡ºè²¨æ—¥"]||'', pickedUp:row["å–è²¨æ—¥"]||''} }; }); items=[...newItems,...items]; saveData(); populateMonthFilter(); renderList(); showToast(`ğŸ‰ æˆåŠŸåŒ¯å…¥ ${newItems.length} ç­†`); }catch(err){showToast("âŒ "+err.message, "error");} finally{input.value='';} }; r.readAsArrayBuffer(f); 
        }

        // å®‰å…¨æ€§
        function togglePinSetting() {
            const isEnabled = document.getElementById('pinToggle').checked;
            const area = document.getElementById('pinChangeArea');
            appSettings.pinEnabled = isEnabled;
            if(isEnabled) { area.classList.remove('hidden'); if(!appSettings.pin) appSettings.pin="0000"; showToast(`å¯†ç¢¼å·²é–‹å•Ÿ`); } 
            else { area.classList.add('hidden'); }
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
        }
        function saveNewPin() {
            const newPin = document.getElementById('newPinInput').value;
            if(newPin.length !== 4 || isNaN(newPin)) { showToast("è«‹è¼¸å…¥4ä½æ•¸å­—", "error"); return; }
            appSettings.pin = newPin;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
            showToast("å¯†ç¢¼ä¿®æ”¹æˆåŠŸ");
            document.getElementById('newPinInput').value = '';
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                        const maxW = 600; const scale = maxW/img.width;
                        const w = (scale<1)?maxW:img.width; const h = (scale<1)?img.height*scale:img.height;
                        cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                        resolve(cvs.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
    </script>
</body>
</html>
