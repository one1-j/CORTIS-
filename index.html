<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CORTIS (V16 å…¨é¸ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-color: #F0ECE6; --card-bg: #FFFFFF; 
            --text-main: #262626; --text-sub: #666666;
            --border: 2px solid #262626; --accent: #d63031; 
            --nav-height: 70px; --select-color: #27ae60;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg-color); color: var(--text-main); 
            font-family: 'Noto Sans TC', 'Inter', sans-serif; margin: 0; padding: 0; 
            padding-bottom: calc(var(--nav-height) + 120px); min-height: 100vh; 
        }

        /* ğŸ”’ é–å®šç•«é¢ */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .pin-container { text-align: center; }
        .pin-title { font-size: 2rem; font-weight: 900; margin-bottom: 20px; }
        .pin-input {
            padding: 15px; font-size: 24px; text-align: center; letter-spacing: 10px;
            border: 2px solid var(--text-main); border-radius: 8px; width: 200px;
            background: #fff; outline: none; font-family: monospace;
        }

        /* é ‚éƒ¨å·¥å…· */
        .top-container {
            background: var(--bg-color); position: sticky; top: 0; z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.1); padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .search-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .filter-row { display: flex; gap: 10px; align-items: center; }
        .search-box { flex: 1; position: relative; }
        .search-input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #999; border-radius: 4px; background: var(--card-bg); font-size: 14px; height: 40px; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        .sort-btn { background: var(--text-main); color: var(--bg-color); border: none; padding: 0 15px; border-radius: 4px; font-size: 13px; font-weight: bold; height: 40px; white-space: nowrap; cursor: pointer; }
        .month-select { flex: 1; padding: 0 8px; border: 2px solid var(--text-main); border-radius: 4px; background: #fff; font-weight: bold; font-size: 13px; color: var(--text-main); height: 40px; }

        .sync-status { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; margin-right: 5px; }
        .sync-status.ok { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .sync-status.loading { background: #f1c40f; animation: pulse 1s infinite; }
        .sync-status.error { background: #e74c3c; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* ç²¾ç°¡ç‰ˆçµ±è¨ˆåˆ— */
        .summary-bar {
            background: #fff; padding: 8px 15px; font-size: 13px; color: #666;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #ddd;
        }
        .summary-val { color: var(--text-main); font-weight: 900; font-family: monospace; font-size: 15px; }

        .view-section { display: none; padding: 20px; max-width: 1000px; margin: 0 auto; animation: fadeIn 0.2s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        h2.page-title { font-size: 1.8rem; font-weight: 900; margin: 0 0 20px 0; border-bottom: var(--border); padding-bottom: 10px; }
        
        .card-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .card-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .merch-card { background: var(--card-bg); border: var(--border); display: flex; flex-direction: column; position: relative; transition: all 0.2s; }
        .merch-card.selected { border-color: var(--select-color); box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.3); }
        .card-select-overlay { position: absolute; top: 10px; left: 10px; z-index: 5; }
        .custom-checkbox { width: 24px; height: 24px; border: 2px solid var(--text-main); background: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; color: transparent; cursor: pointer; }
        .merch-card.selected .custom-checkbox { background: var(--text-main); color: #fff; }
        .card-status-bar { height: 6px; background: #eee; width: 100%; display: flex; }
        .status-segment { flex: 1; border-right: 1px solid #fff; opacity: 0.2; background: var(--text-main); }
        .status-segment.active { opacity: 1; }
        .card-header { padding: 15px; padding-left: 45px; display: flex; gap: 15px; border-bottom: 1px dashed #ccc; }
        .card-thumb { width: 80px; height: 80px; background: #eee; border: 1px solid #ccc; object-fit: cover; flex-shrink: 0; }
        .card-title-group { flex: 1; overflow: hidden; }
        .category-tag { font-size: 11px; background: #eee; padding: 2px 6px; border-radius: 2px; font-weight: 600; display: inline-block; margin-bottom: 4px; }
        .group-tag { font-size: 11px; background: var(--text-main); color: #fff; padding: 2px 6px; border-radius: 2px; font-weight: 600; display: inline-block; margin-bottom: 4px; margin-right: 5px; }
        .remove-group { cursor: pointer; margin-left: 5px; opacity: 0.7; }
        .card-title { font-size: 17px; font-weight: 900; margin: 0 0 5px 0; line-height: 1.3; }
        .card-subtitle { font-size: 13px; color: var(--text-sub); }
        .contact-link { color: #000; text-decoration: underline; font-weight: bold; cursor: pointer; }
        
        .info-grid { padding: 15px; display: grid; grid-template-columns: 85px 1fr; gap: 8px; font-size: 14px; align-items: baseline; }
        .label { color: var(--text-sub); font-weight: 500; text-align-last: justify; }
        .value { font-weight: 600; text-align: right; font-family: 'Inter', monospace; }
        .value.highlight { font-weight: 900; font-size: 16px; border-top: 1px dashed #999; padding-top: 5px; margin-top: 5px; }
        
        /* ç‹€æ…‹å‹¾é¸å€ */
        .checklist-col { padding: 10px 15px; background: #f9f9f9; border-top: 1px solid #eee; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .check-group { display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
        .check-left { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .check-box { width: 14px; height: 14px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 10px; color: transparent; }
        .check-group.checked .check-box { background: #333; color: #fff; }
        .check-group.checked .check-label { font-weight: bold; }
        
        .mini-date {
            border: none; background: transparent; font-size: 12px; color: #666;
            text-align: right; width: 110px; font-family: 'Inter', monospace;
            padding: 0; height: auto; line-height: normal;
        }
        .mini-date:focus { outline: none; color: #000; }

        .card-actions { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; }
        .action-btn { background: transparent; border: none; padding: 12px 2px; font-size: 12px; font-weight: 700; border-right: 1px solid #eee; color: var(--text-main); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .action-btn:last-child { border: none; }
        .action-btn:disabled { color: #ccc; cursor: default; }

        /* è¡¨å–®æ¨£å¼ */
        .form-container { background: var(--card-bg); padding: 20px; border: var(--border); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-col { flex: 1; width: 50%; } 
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 5px; }
        input, select, textarea { 
            width: 100%; padding: 0 10px; border: 1px solid #ccc; border-radius: 0; background: #fff; font-size: 15px; 
            color: var(--text-main); height: 44px; line-height: 44px; box-sizing: border-box; -webkit-appearance: none; appearance: none;
        }
        textarea { height: 80px; line-height: 1.5; padding: 10px; }
        input[type="file"] { padding: 10px; line-height: 1.2; height: auto; }
        .btn-main { width: 100%; background: var(--text-main); color: #fff; padding: 15px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; letter-spacing: 1px; }
        
        #transferFields { background: #f4f4f4; border: 1px solid #ddd; padding: 15px 10px; margin-bottom: 15px; border-radius: 4px; }
        #transferFields .form-row { margin-bottom: 0; }
        .info-input-grid { display: flex; gap: 10px; background: #f9f9f9; padding: 10px; border: 1px solid #eee; }
        .info-input-item { flex: 1; text-align: center; }
        .info-input-item input { text-align: right; }

        /* è¨­å®šé  */
        .stats-box { background: var(--text-main); color: #fff; padding: 20px; margin-bottom: 20px; text-align: center; }
        .stats-big-num { font-size: 32px; font-weight: 900; font-family: monospace; }
        .settings-group { background: #fff; border: var(--border); padding: 20px; margin-bottom: 20px; }
        .btn-backup { background: #eee; border: 1px solid #ccc; padding: 12px; width: 100%; margin-bottom: 10px; font-weight: bold; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-excel { background: #27ae60; color: white; border: none; }

        .toggle-switch { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--text-main); }
        input:checked + .slider:before { transform: translateX(24px); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: var(--card-bg); border-top: var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; color: #999; font-size: 11px; font-weight: 700; cursor: pointer; padding-top: 10px; }
        .nav-item.active { color: var(--text-main); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }

        .bulk-actions-bar { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(150px); background: var(--text-main); color: #fff; padding: 10px 20px; display: flex; gap: 10px; align-items: center; border-radius: 50px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: transform 0.3s; z-index: 99; white-space: nowrap; overflow-x: auto; max-width: 90%; }
        .bulk-actions-bar.active { transform: translateX(-50%) translateY(0); }
        .bulk-btn { background: #fff; color: #000; border: none; padding: 5px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .bulk-btn.danger { background: var(--accent); color: #fff; }
        .bulk-btn.select-all { background: #f39c12; color: #fff; }

        .hidden { display: none; }
        .text-red { color: var(--accent); }
    </style>
</head>
<body>

    <div id="lockScreen">
        <div class="pin-container">
            <div class="pin-title">LOCKED</div>
            <div class="pin-msg">è«‹è¼¸å…¥ PIN ç¢¼</div>
            <input type="password" id="pinInput" class="pin-input" maxlength="4" pattern="[0-9]*" inputmode="numeric">
        </div>
    </div>

    <div class="top-container">
        <div class="search-row">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å•†å“åç¨±..." oninput="renderList()">
            </div>
            <button class="sort-btn" onclick="toggleSort()">â‡…</button>
        </div>
        <div class="filter-row">
            <select id="monthFilter" class="month-select" onchange="renderList()">
                <option value="all">ğŸ“… æ‰€æœ‰æœˆä»½</option>
            </select>
            <div id="syncIndicator" class="sync-status" title="é›²ç«¯åŒæ­¥ç‹€æ…‹"></div>
        </div>
    </div>

    <div id="view-home" class="view-section active">
        <div class="summary-bar">
            <span>ç•¶å‰èŠ±è²»</span>
            <span class="summary-val" id="summaryTotal">NT$ 0</span>
            <span style="font-size:12px; margin-left:10px;">( <span id="summaryCount">0</span> ç­† )</span>
        </div>

        <div id="merchGrid" class="card-grid" style="margin-top:15px;"></div>
        <div id="emptyState" style="text-align:center; padding:50px; color:#999; display:none;">ç›®å‰æ²’æœ‰ç´€éŒ„</div>
    </div>

    <div id="view-add" class="view-section">
        <h2 class="page-title" id="pageTitle">æ–°å¢ç´€éŒ„</h2>
        <div class="form-container">
            <form id="merchForm">
                <input type="hidden" id="editId">
                <div class="form-group"><label>å•†å“åç¨± <span style="color:red">*</span></label><input type="text" id="name" required></div>
                
                <div class="form-row">
                    <div class="form-col">
                        <label>åˆ†é¡</label>
                        <select id="category"><option>å‘¨é‚Š</option><option>å°ˆè¼¯</option><option>å°å¡</option><option>ç¥¨å‹™</option><option>å…¶ä»–</option></select>
                    </div>
                    <div class="form-col">
                        <label>ä¸‹å–®æ—¥æœŸ <span style="color:red">*</span></label><input type="date" id="orderDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>è³£å®¶è¯çµ¡æ–¹å¼</label>
                    <div class="form-row" style="margin-bottom:0;">
                        <div class="form-col"><input type="text" id="contact" placeholder="åç¨± (ä¾‹: æ¨ç‰¹@abc)"></div>
                        <div class="form-col"><input type="url" id="contactLink" placeholder="é€£çµ (é¸å¡«)"></div>
                    </div>
                </div>

                <div class="form-group"><label>ä»˜æ¬¾æ–¹å¼</label>
                    <select id="paymentType" onchange="toggleTransferFields()">
                        <option value="Pending">å¾…ä»˜æ¬¾</option>
                        <option value="COD">è²¨åˆ°ä»˜æ¬¾</option>
                        <option value="Transfer">éŠ€è¡ŒåŒ¯æ¬¾</option>
                    </select>
                </div>

                <div id="transferFields" class="hidden">
                    <div class="form-row">
                        <div class="form-col"><label>åŒ¯æ¬¾æ—¥æœŸ</label><input type="date" id="transferDate"></div>
                        <div class="form-col"><label>é‡‘é¡</label><input type="number" id="transferAmount"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>è²»ç”¨ (NT$)</label>
                    <div class="info-input-grid">
                        <div class="info-input-item"><label>å–®åƒ¹</label><input type="number" id="price"></div>
                        <div class="info-input-item"><label>äºŒè£œ</label><input type="number" id="secondPay"></div>
                        <div class="info-input-item"><label>é‹è²»</label><input type="number" id="shipping"></div>
                    </div>
                </div>

                <div class="form-group"><label>é€£çµ</label><input type="url" id="link" placeholder="è¨‚è³¼..." style="margin-bottom:5px;"><input type="url" id="reconcileLink" placeholder="å°å¸³è¡¨..." style="margin-bottom:5px;"><input type="url" id="sellerLink" placeholder="è³£è²¨ä¾¿..."></div>
                <div class="form-group"><label>å‚™è¨»</label><textarea id="notes" style="height:60px;"></textarea></div>
                <div class="form-group"><label>åœ–ç‰‡</label><input type="file" id="imageInput" accept="image/*"></div>
                <button type="submit" class="btn-main" id="submitBtn">å„²å­˜</button>
                <button type="button" class="btn-main" id="cancelBtn" onclick="resetForm()" style="background:#999; margin-top:10px; display:none;">å–æ¶ˆç·¨è¼¯</button>
            </form>
        </div>
    </div>

    <div id="view-settings" class="view-section">
        <h2 class="page-title">ç®¡ç†</h2>
        
        <h3 style="margin-bottom:10px;">è³‡æ–™åŒ¯å…¥/å‚™ä»½</h3>
        <div class="settings-group">
            <button class="btn-backup btn-excel" onclick="downloadTemplate()">ğŸ“Š ä¸‹è¼‰ Excel ç¯„æœ¬</button>
            <div style="position:relative; margin-top:10px;"><button class="btn-backup btn-excel" style="background:#262626;" onclick="document.getElementById('excelInput').click()">ğŸ“¥ åŒ¯å…¥ Excel</button><input type="file" id="excelInput" onchange="importExcel(this)" accept=".xlsx, .xls, .csv" style="display:none;"></div>
            <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
            <button class="btn-backup" onclick="exportData()">â¬‡ ä¸‹è¼‰ JSON å‚™ä»½</button>
            <div style="position:relative; margin-top:10px;"><button class="btn-backup" onclick="document.getElementById('jsonInput').click()">â¬† åŒ¯å…¥ JSON å‚™ä»½</button><input type="file" id="jsonInput" onchange="importData(this)" accept=".json" style="display:none;"></div>
            <button class="btn-backup" onclick="forceCloudSync()" style="background:#3498db; color:fff; margin-top:20px;">â˜ å¼·åˆ¶é›²ç«¯åŒæ­¥</button>
            <button class="btn-backup" onclick="clearAllData()" style="background:var(--accent); color:#fff; margin-top:10px;">âš  æ¸…ç©ºè³‡æ–™</button>
        </div>

        <h3 style="margin:20px 0 10px 0;">å®‰å…¨æ€§</h3>
        <div class="settings-group">
            <div class="toggle-switch">
                <span>å•Ÿç”¨ PIN ç¢¼é–å®š</span>
                <label class="switch"><input type="checkbox" id="pinToggle" onchange="togglePinSetting()"><span class="slider"></span></label>
            </div>
            <div id="pinChangeArea" class="hidden" style="margin-top:10px;">
                <input type="number" id="newPinInput" placeholder="è¼¸å…¥æ–° PIN (4ç¢¼)" style="margin-bottom:5px;" maxlength="4">
                <button class="btn-backup" onclick="saveNewPin()" style="background:#262626; color:#fff;">å„²å­˜æ–°å¯†ç¢¼</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œåˆ— (å«å…¨é¸) -->
    <div id="bulkActions" class="bulk-actions-bar">
        <div style="font-size:12px;">å·²é¸ <span id="selectedCount">0</span> ç­†</div>
        <button class="bulk-btn select-all" onclick="selectAllVisible()">âœ… å…¨é¸</button>
        <button class="bulk-btn" onclick="mergeSelectedItems()">ğŸ”— åˆä½µ</button>
        <button class="bulk-btn danger" onclick="deleteSelectedItems()">ğŸ—‘ åˆªé™¤</button>
        <button class="bulk-btn" onclick="clearSelection()" style="background:#666; color:#fff;">å–æ¶ˆ</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchView('home', this)"><span class="nav-icon">â˜°</span>åˆ—è¡¨</div>
        <div class="nav-item" onclick="switchView('add', this)"><span class="nav-icon">ï¼‹</span>æ–°å¢</div>
        <div class="nav-item" onclick="switchView('settings', this)"><span class="nav-icon">âš™</span>ç®¡ç†</div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyeGblocTD-g8e3yUbG0YSMBRbT-6Uwfu2gF09Bjgqt32C_GIjBwnl-Ni2-cfDwXQfl4g/exec";
        const STORAGE_KEY = 'cortis_v16_data';
        const SETTINGS_KEY = 'cortis_v16_settings';
        
        let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let appSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { pinEnabled: false, pin: "0000" };
        
        let sortDesc = true;
        let selectedIds = new Set();
        let isSyncing = false;

        const views = { home: document.getElementById('view-home'), add: document.getElementById('view-add'), settings: document.getElementById('view-settings') };
        const STATUS_KEYS = ['notArrived', 'pendingShip', 'shipped', 'pickedUp'];
        const STATUS_LABELS = { notArrived:'æœªåˆ°è²¨', pendingShip:'å¾…å‡ºè²¨', shipped:'å·²å‡ºè²¨', pickedUp:'å–è²¨' };
        const PAYMENT_LABELS = { Pending:'å¾…ä»˜æ¬¾', COD:'è²¨åˆ°ä»˜æ¬¾', Transfer:'éŠ€è¡ŒåŒ¯æ¬¾' };

        window.onload = () => {
            document.getElementById('pinToggle').checked = appSettings.pinEnabled;
            if(appSettings.pinEnabled) {
                document.getElementById('pinChangeArea').classList.remove('hidden');
                document.getElementById('lockScreen').style.display = 'flex';
                document.getElementById('pinInput').addEventListener('input', checkPin);
                document.getElementById('pinInput').focus();
            } else {
                initApp();
            }
        };

        function checkPin(e) {
            if (e.target.value === appSettings.pin) {
                document.getElementById('lockScreen').style.display = 'none';
                initApp();
            }
        }

        function initApp() {
            renderList(); populateMonthFilter();
            document.getElementById('orderDate').valueAsDate = new Date();
            syncWithCloud();
        }

        function togglePinSetting() {
            const isEnabled = document.getElementById('pinToggle').checked;
            const area = document.getElementById('pinChangeArea');
            appSettings.pinEnabled = isEnabled;
            if(isEnabled) {
                area.classList.remove('hidden');
                if(!appSettings.pin) appSettings.pin = "0000";
                alert(`å·²é–‹å•Ÿï¼Œé è¨­å¯†ç¢¼: ${appSettings.pin}`);
            } else {
                area.classList.add('hidden');
            }
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
        }

        function saveNewPin() {
            const newPin = document.getElementById('newPinInput').value;
            if(newPin.length !== 4 || isNaN(newPin)) { alert("è«‹è¼¸å…¥4ä½æ•¸å­—"); return; }
            appSettings.pin = newPin;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
            alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸ");
            document.getElementById('newPinInput').value = '';
        }

        const form = document.getElementById('merchForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;

            if(!document.getElementById('name').value || !document.getElementById('orderDate').value) {
                alert("è«‹å¡«å¯«å•†å“åç¨±èˆ‡ä¸‹å–®æ—¥æœŸ"); btn.innerText = "å„²å­˜"; btn.disabled = false; return;
            }

            try {
                const editId = document.getElementById('editId').value;
                const imgInput = document.getElementById('imageInput');
                let imgData = null;
                
                if(imgInput.files && imgInput.files[0]) {
                    try { imgData = await compressImage(imgInput.files[0]); } 
                    catch(err) { console.warn("åœ–ç‰‡å£“ç¸®å¤±æ•—"); }
                }

                const rawData = {
                    name: document.getElementById('name').value, category: document.getElementById('category').value,
                    orderDate: document.getElementById('orderDate').value, source: document.getElementById('source').value, 
                    contact: document.getElementById('contact').value, contactLink: document.getElementById('contactLink').value,
                    paymentType: document.getElementById('paymentType').value, transferDate: document.getElementById('transferDate').value, 
                    transferAmount: Number(document.getElementById('transferAmount').value), price: Number(document.getElementById('price').value), 
                    secondPay: Number(document.getElementById('secondPay').value), shipping: Number(document.getElementById('shipping').value), 
                    link: document.getElementById('link').value, reconcileLink: document.getElementById('reconcileLink').value,
                    sellerLink: document.getElementById('sellerLink').value, notes: document.getElementById('notes').value
                };

                if(editId) {
                    const idx = items.findIndex(i => i.id == editId);
                    if(idx > -1) {
                        items[idx] = { ...items[idx], ...rawData };
                        if(imgData) items[idx].imageSrc = imgData;
                    }
                } else {
                    items.unshift({ 
                        id: Date.now(), ...rawData, imageSrc: imgData, group:null, 
                        status: {notArrived:true, pendingShip:false, shipped:false, pickedUp:false},
                        dates: {pendingShip:'', shipped:'', pickedUp:''},
                        refund: { isRefunded: false } 
                    });
                }

                saveData(); resetForm(); populateMonthFilter();
                switchView('home', document.querySelectorAll('.nav-item')[0]);
                
            } catch (error) { alert("éŒ¯èª¤: " + error.message); } 
            finally { btn.innerText = "å„²å­˜"; btn.disabled = false; }
        });

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                        const maxW = 600; const scale = maxW/img.width;
                        const w = (scale<1)?maxW:img.width; const h = (scale<1)?img.height*scale:img.height;
                        cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                        resolve(cvs.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function syncWithCloud() {
            const ind = document.getElementById('syncIndicator');
            if(isSyncing) return; isSyncing = true; ind.className = 'sync-status loading';
            try {
                const res = await fetch(API_URL); const cloudData = await res.json();
                if(Array.isArray(cloudData) && cloudData.length >= items.length) {
                    items = cloudData; localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                    renderList(); populateMonthFilter();
                }
                ind.className = 'sync-status ok';
            } catch(e) { ind.className = 'sync-status error'; } finally { isSyncing = false; }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); updateSummary();
                fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(items) });
            } catch (e) { alert("âŒ å„²å­˜ç©ºé–“ä¸è¶³"); }
        }

        function switchView(view, el) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            views[view].classList.add('active'); el.classList.add('active');
            if(view === 'home') renderList();
            window.scrollTo(0,0);
        }

        function populateMonthFilter() {
            const select = document.getElementById('monthFilter');
            const currentVal = select.value;
            const months = [...new Set(items.map(i => i.orderDate.substring(0, 7)))].sort().reverse();
            let html = '<option value="all">ğŸ“… æ‰€æœ‰æœˆä»½</option>';
            months.forEach(m => { const [y, mm] = m.split('-'); html += `<option value="${m}">${y}å¹´ ${mm}æœˆ</option>`; });
            select.innerHTML = html;
            if(months.includes(currentVal)) select.value = currentVal; else select.value = "all";
        }

        function updateSummary(filteredItems = items) {
            const total = filteredItems.reduce((acc, i) => acc + (i.price||0) + (i.secondPay||0) + (i.shipping||0), 0);
            document.getElementById('summaryTotal').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('summaryCount').innerText = filteredItems.length;
        }

        function renderList() {
            const grid = document.getElementById('merchGrid'); grid.innerHTML = '';
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const monthVal = document.getElementById('monthFilter').value;
            let filtered = items.filter(i => {
                const matchK = (i.name||'').toLowerCase().includes(keyword);
                const matchM = monthVal === 'all' || i.orderDate.startsWith(monthVal);
                return matchK && matchM;
            });
            filtered.sort((a,b) => sortDesc ? new Date(b.orderDate)-new Date(a.orderDate) : new Date(a.orderDate)-new Date(b.orderDate));
            document.getElementById('emptyState').style.display = filtered.length ? 'none' : 'block';
            updateSummary(filtered);

            filtered.forEach(item => {
                const total = (item.price||0) + (item.secondPay||0) + (item.shipping||0);
                
                let checksHtml = '';
                STATUS_KEYS.forEach(k => {
                    const checked = item.status[k] ? 'checked' : '';
                    const dateVal = (item.dates && item.dates[k]) ? item.dates[k] : '';
                    let dateInputHtml = '';
                    if (['pendingShip', 'shipped', 'pickedUp'].includes(k)) {
                        dateInputHtml = `<input type="date" class="mini-date" value="${dateVal}" onchange="updateStatusDate(${item.id}, '${k}', this.value)" onclick="event.stopPropagation()">`;
                    }
                    checksHtml += `
                        <div class="check-group ${checked}">
                            <div class="check-left" onclick="toggleStatus(${item.id}, '${k}')">
                                <div class="check-box">âœ”</div>
                                <span class="check-label">${STATUS_LABELS[k]}</span>
                            </div>
                            ${dateInputHtml}
                        </div>`;
                });

                let contactDisplay = item.contact || '-';
                if(item.contactLink) contactDisplay = `<a class="contact-link" onclick="window.open('${item.contactLink}', '_blank')">${item.contact || 'é€£çµ'}</a>`;
                let groupHtml = item.group ? `<span class="group-tag">ğŸ“¦ ${item.group} <span class="remove-group" onclick="ungroupItem(${item.id})">Ã—</span></span>` : '';
                const isSelected = selectedIds.has(item.id) ? 'selected' : '';
                const checkMark = selectedIds.has(item.id) ? 'âœ”' : '';
                const openUrl = (url) => url ? `window.open('${url}','_blank')` : '';
                const btnStyle = (url) => url ? '' : 'color:#ccc; cursor:default;';

                const card = document.createElement('div');
                card.className = `merch-card ${isSelected}`;
                card.innerHTML = `
                    <div class="card-select-overlay" onclick="toggleSelection(${item.id})"><div class="custom-checkbox">${checkMark}</div></div>
                    <div class="card-status-bar">${STATUS_KEYS.map(k => `<div class="status-segment ${item.status[k]?'active':''}"></div>`).join('')}</div>
                    <div class="card-header">${item.imageSrc ? `<img src="${item.imageSrc}" class="card-thumb">` : `<div class="card-thumb"></div>`}
                        <div class="card-title-group"><div>${groupHtml}<span class="category-tag">${item.category||'å‘¨é‚Š'}</span></div><div class="card-title">${item.name}</div><div class="card-subtitle">${item.orderDate} Â· ${item.source||''}</div></div>
                    </div>
                    <div class="info-grid">
                        <span class="label">è³£å®¶è¯çµ¡</span><span class="value" style="font-size:13px;">${contactDisplay}</span>
                        <span class="label">ä»˜æ¬¾æ–¹å¼</span><span class="value" style="font-size:13px;">${PAYMENT_LABELS[item.paymentType] || item.paymentType}</span>
                        <span class="label">å–®åƒ¹</span><span class="value">${item.price||0}</span>
                        <span class="label">äºŒè£œ</span><span class="value">${item.secondPay||0}</span>
                        <span class="label">åœ‹éš›é‹è²»</span><span class="value">${item.shipping||0}</span>
                        <span class="label" style="font-weight:900; color:#000;">ç¸½è¨ˆ</span><span class="value highlight">NT$ ${total}</span>
                    </div>
                    <div class="checklist-col">${checksHtml}</div>
                    <div class="card-actions">
                        <button class="action-btn" onclick="editItem(${item.id})">ç·¨è¼¯</button>
                        <button class="action-btn" onclick="${openUrl(item.link)}" style="${btnStyle(item.link)}">è¨‚è³¼</button>
                        <button class="action-btn" onclick="${openUrl(item.reconcileLink)}" style="${btnStyle(item.reconcileLink)}">å°å¸³è¡¨</button>
                        <button class="action-btn text-red" onclick="deleteItem(${item.id})">åˆªé™¤</button>
                    </div>`;
                grid.appendChild(card);
            });
            updateBulkBar();
        }

        function toggleStatus(id, key) {
            const item = items.find(i => i.id === id);
            if(item) {
                const newStatus = !item.status[key];
                item.status[key] = newStatus;
                if(newStatus && ['pendingShip', 'shipped', 'pickedUp'].includes(key)) {
                    if(!item.dates) item.dates = {};
                    if(!item.dates[key]) {
                        item.dates[key] = new Date().toISOString().split('T')[0];
                    }
                }
                saveData(); renderList();
            }
        }

        function updateStatusDate(id, key, dateValue) {
            const item = items.find(i => i.id === id);
            if(item) {
                if(!item.dates) item.dates = {};
                item.dates[key] = dateValue;
                if(dateValue && !item.status[key]) item.status[key] = true;
                saveData();
            }
        }

        function toggleSelection(id) { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); renderList(); }
        function clearSelection() { selectedIds.clear(); renderList(); }
        function updateBulkBar() { const bar = document.getElementById('bulkActions'); if(selectedIds.size > 0) { bar.classList.add('active'); document.getElementById('selectedCount').innerText = selectedIds.size; } else { bar.classList.remove('active'); } }
        function mergeSelectedItems() { const name = prompt("è¼¸å…¥ä½µå–®åç¨±:"); if(name) { items.forEach(i => { if(selectedIds.has(i.id)) i.group = name; }); clearSelection(); saveData(); renderList(); } }
        
        // --- æ–°å¢ï¼šå…¨é¸åŠŸèƒ½ ---
        function selectAllVisible() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const monthVal = document.getElementById('monthFilter').value;
            
            const filtered = items.filter(i => {
                const matchK = (i.name||'').toLowerCase().includes(keyword);
                const matchM = monthVal === 'all' || i.orderDate.startsWith(monthVal);
                return matchK && matchM;
            });
            
            filtered.forEach(i => selectedIds.add(i.id));
            renderList();
        }

        function deleteSelectedItems() { if(confirm(`ç¢ºå®šåˆªé™¤é¸å–çš„ ${selectedIds.size} ç­†è³‡æ–™ï¼Ÿ`)) { items = items.filter(i => !selectedIds.has(i.id)); clearSelection(); saveData(); renderList(); populateMonthFilter(); } }
        function ungroupItem(id) { if(confirm("ç§»é™¤ä½µå–®ï¼Ÿ")) { const i = items.find(x => x.id === id); if(i) { i.group = null; saveData(); renderList(); } } }
        function toggleSort() { sortDesc = !sortDesc; renderList(); }
        
        function editItem(id) {
            const item = items.find(i => i.id === id); if(!item) return;
            document.getElementById('editId').value = item.id; document.getElementById('name').value = item.name;
            document.getElementById('category').value = item.category; document.getElementById('orderDate').value = item.orderDate;
            document.getElementById('source').value = item.source || ''; document.getElementById('contact').value = item.contact;
            document.getElementById('contactLink').value = item.contactLink || ''; document.getElementById('paymentType').value = item.paymentType; 
            document.getElementById('transferDate').value = item.transferDate; document.getElementById('transferAmount').value = item.transferAmount; 
            document.getElementById('price').value = item.price; document.getElementById('secondPay').value = item.secondPay; 
            document.getElementById('shipping').value = item.shipping; document.getElementById('link').value = item.link; 
            document.getElementById('reconcileLink').value = item.reconcileLink || ''; document.getElementById('sellerLink').value = item.sellerLink; 
            document.getElementById('notes').value = item.notes; toggleTransferFields();
            document.getElementById('pageTitle').innerText = "ç·¨è¼¯ç´€éŒ„"; document.getElementById('submitBtn').innerText = "æ›´æ–°è³‡æ–™"; document.getElementById('cancelBtn').style.display = 'block';
            switchView('add', document.querySelectorAll('.nav-item')[1]);
        }
        function resetForm() { form.reset(); document.getElementById('editId').value = ''; document.getElementById('pageTitle').innerText="æ–°å¢ç´€éŒ„"; document.getElementById('submitBtn').innerText="å„²å­˜ç´€éŒ„"; document.getElementById('cancelBtn').style.display='none'; toggleTransferFields(); }
        function deleteItem(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { items = items.filter(i => i.id !== id); if(selectedIds.has(id)) selectedIds.delete(id); saveData(); renderList(); populateMonthFilter(); } }
        function toggleTransferFields() { document.getElementById('transferFields').style.display = document.getElementById('paymentType').value === 'Transfer' ? 'block' : 'none'; }
        function forceCloudSync() { if(confirm("å¼·åˆ¶ä¸Šå‚³ï¼Ÿ")) { const ind = document.getElementById('syncIndicator'); ind.className = 'sync-status loading'; fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(items) }).then(()=>{ alert("å·²é€å‡º"); ind.className='sync-status ok'; }).catch(()=>{ alert("å¤±æ•—"); ind.className='sync-status error'; }); } }
        function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(items,null,2)],{type:'application/json'})); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function importData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload=e=>{ try{ items=JSON.parse(e.target.result); saveData(); populateMonthFilter(); renderList(); alert('åŒ¯å…¥æˆåŠŸ'); }catch{ alert('éŒ¯èª¤'); } }; r.readAsText(f); }
        function clearAllData() { if(confirm('æ¸…ç©ºï¼Ÿ')) { items=[]; saveData(); populateMonthFilter(); renderList(); } }
        
        function downloadTemplate() { if(typeof XLSX==='undefined'){alert('ç¶²è·¯éŒ¯èª¤');return;} const data=[{"å•†å“åç¨±":"ç¯„ä¾‹","åˆ†é¡":"å‘¨é‚Š","ä¸‹å–®æ—¥æœŸ":"2025-01-01","è³¼è²·ä¾†æº":"å®˜ç¶²","è³£å®¶åç¨±":"@abc","è³£å®¶é€£çµ":"","ä»˜æ¬¾æ–¹å¼ (å¾…ä»˜æ¬¾/è²¨åˆ°ä»˜æ¬¾/éŠ€è¡ŒåŒ¯æ¬¾)":"éŠ€è¡ŒåŒ¯æ¬¾","åŒ¯æ¬¾æ—¥æœŸ":"2025-01-01","åŒ¯æ¬¾é‡‘é¡":500,"å–®åƒ¹":500,"äºŒè£œ":0,"åœ‹éš›é‹è²»":60,"å¾…å‡ºè²¨æ—¥":"","å·²å‡ºè²¨æ—¥":"","å–è²¨æ—¥":"","è¨‚è³¼é€£çµ":"","å°å¸³è¡¨é€£çµ":"","è³£è²¨ä¾¿é€£çµ":"","å‚™è¨»":""}]; XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(data), "Sheet1")), "CORTIS_V16ç¯„æœ¬.xlsx"); }
        function importExcel(input) { if(typeof XLSX==='undefined'){alert('ç¶²è·¯éŒ¯èª¤');input.value='';return;} const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(json.length===0)throw new Error("ç„¡è³‡æ–™"); const newItems=json.map(row=>{ let pType="Pending"; const pRaw=row["ä»˜æ¬¾æ–¹å¼ (å¾…ä»˜æ¬¾/è²¨åˆ°ä»˜æ¬¾/éŠ€è¡ŒåŒ¯æ¬¾)"]||""; if(pRaw.includes("è²¨åˆ°"))pType="COD"; else if(pRaw.includes("åŒ¯æ¬¾"))pType="Transfer"; return { id:Date.now()+Math.floor(Math.random()*100000), name:row["å•†å“åç¨±"]||"æœªå‘½å", category:row["åˆ†é¡"]||"å‘¨é‚Š", orderDate:row["ä¸‹å–®æ—¥æœŸ"]||new Date().toISOString().split('T')[0], source:row["è³¼è²·ä¾†æº"]||"", contact:row["è³£å®¶åç¨±"]||"", contactLink:row["è³£å®¶é€£çµ"]||"", paymentType:pType, transferDate:row["åŒ¯æ¬¾æ—¥æœŸ"]||"", transferAmount:Number(row["åŒ¯æ¬¾é‡‘é¡"])||0, price:Number(row["å–®åƒ¹"])||0, secondPay:Number(row["äºŒè£œ"])||0, shipping:Number(row["åœ‹éš›é‹è²»"])||0, link:row["è¨‚è³¼é€£çµ"]||"", reconcileLink:row["å°å¸³è¡¨é€£çµ"]||"", sellerLink:row["è³£è²¨ä¾¿é€£çµ"]||"", notes:row["å‚™è¨»"]||"", imageSrc:"", group:null, status:{notArrived:true, pendingShip:!!row["å¾…å‡ºè²¨æ—¥"], shipped:!!row["å·²å‡ºè²¨æ—¥"], pickedUp:!!row["å–è²¨æ—¥"]}, dates:{pendingShip:row["å¾…å‡ºè²¨æ—¥"]||'', shipped:row["å·²å‡ºè²¨æ—¥"]||'', pickedUp:row["å–è²¨æ—¥"]||''} }; }); items=[...newItems,...items]; saveData(); populateMonthFilter(); renderList(); alert(`ğŸ‰ åŒ¯å…¥ ${newItems.length} ç­†`); }catch(err){alert("âŒ "+err.message);} finally{input.value='';} }; r.readAsArrayBuffer(f); }
    </script>
</body>
</html>
