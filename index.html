<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CORTIS å‘¨é‚Šç´€éŒ„ (V8 é›²ç«¯ç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORTIS THEME --- */
        :root {
            --bg-color: #F0ECE6; --card-bg: #FFFFFF; 
            --text-main: #262626; --text-sub: #666666;
            --border: 2px solid #262626; --accent: #d63031; 
            --font-stack: 'Noto Sans TC', 'Inter', sans-serif;
            --select-color: #27ae60;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: var(--font-stack); margin: 0; padding: 0; min-height: 100vh; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1 { font-size: 2.5rem; font-weight: 900; text-align: center; margin: 20px 0; border-bottom: var(--border); padding-bottom: 20px; }
        
        .form-panel { background: var(--card-bg); border: var(--border); padding: 20px; margin-bottom: 30px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-col { flex: 1; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 0; font-size: 15px; }
        .btn-submit { width: 100%; background: var(--text-main); color: #fff; padding: 15px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-submit:disabled { background: #999; }

        .merch-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 600px) { .merch-grid { grid-template-columns: repeat(2, 1fr); } }

        .merch-card { background: var(--card-bg); border: var(--border); position: relative; }
        .card-header { padding: 15px; border-bottom: 1px dashed #ccc; display: flex; gap: 15px; align-items: center; }
        .card-thumb { width: 60px; height: 60px; object-fit: cover; border: 1px solid #ccc; flex-shrink: 0; }
        .card-title { font-weight: 900; font-size: 17px; margin: 0; }
        .card-subtitle { font-size: 12px; color: var(--text-sub); }
        .card-body { padding: 15px; }
        .info-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .total-row { font-weight: bold; font-size: 16px; text-align: right; border-top: 1px solid #eee; padding-top: 5px; margin-top: 10px; }
        .card-actions { text-align: right; margin-top: 10px; }
        .action-btn { background: none; border: none; font-weight: bold; cursor: pointer; margin-left: 10px; }
        
        .sync-status { text-align: center; font-size: 12px; color: #999; padding: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>CORTIS MERCH TRACKER</h1>
        </header>

        <div class="form-panel">
            <h2 style="margin-top:0;">æ–°å¢ç´€éŒ„</h2>
            <form id="merchForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-col"><label>å•†å“åç¨±*</label><input type="text" id="name" required></div>
                    <div class="form-col"><label>ä¸‹å–®æ—¥æœŸ*</label><input type="date" id="orderDate" required></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label>ä¾†æº</label><input type="text" id="source"></div>
                    <div class="form-col"><label>è¯çµ¡</label><input type="text" id="contact"></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label>å–®åƒ¹</label><input type="number" id="price"></div>
                    <div class="form-col"><label>äºŒè£œ</label><input type="number" id="secondPay"></div>
                    <div class="form-col"><label>é‹è²»</label><input type="number" id="shipping"></div>
                </div>
                <div class="form-group"><label>å‚™è¨»</label><textarea id="notes" rows="2"></textarea></div>
                <div class="form-group"><label>åœ–ç‰‡</label><input type="file" id="imageInput" accept="image/*"></div>
                <button type="submit" class="btn-submit">å„²å­˜</button>
            </form>
        </div>

        <div class="sync-status" id="syncStatus">ğŸ”„ è®€å–è³‡æ–™ä¸­...</div>
        <div id="merchList" class="merch-grid"></div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ–èˆ‡è®Šæ•¸ ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwYC0jwUIhYHTH1cIYI_-7TYc77jxzJW63jIOzzsosFb-AfOWG9kfURQi5hlsnk-O60-w/exec"; 
        const STORAGE_KEY = 'cortis_v8_cloud';
        const form = document.getElementById('merchForm');
        const grid = document.getElementById('merchList');
        const syncStatus = document.getElementById('syncStatus');

        let items = [];

        window.onload = () => {
            document.getElementById('orderDate').valueAsDate = new Date();
            loadData();
            registerServiceWorker(); // è¨»å†Š PWA
        };

        // --- 2. é›²ç«¯åŒæ­¥èˆ‡è³‡æ–™è™•ç† ---
        
        async function loadData() {
            syncStatus.innerText = "ğŸ”„ è®€å–è³‡æ–™ä¸­...";
            try {
                // å„ªå…ˆå¾é›²ç«¯è®€å–
                const response = await fetch(API_URL);
                const cloudData = await response.json();
                if (Array.isArray(cloudData)) {
                    items = cloudData;
                    syncStatus.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥æˆåŠŸ";
                    // å°‡é›²ç«¯è³‡æ–™å¯«å›æœ¬æ©Ÿ
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                }
            } catch (e) {
                // é›²ç«¯å¤±æ•—ï¼Œæ”¹è®€æœ¬æ©Ÿ
                console.warn("é›²ç«¯è®€å–å¤±æ•—ï¼Œä½¿ç”¨æœ¬æ©Ÿè³‡æ–™", e);
                items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
                syncStatus.innerText = "ğŸ”Œ é›¢ç·šæ¨¡å¼";
            }
            renderList();
        }

        async function saveData() {
            // å…ˆå­˜æœ¬æ©Ÿï¼Œç¢ºä¿ä»‹é¢åæ‡‰å¿«é€Ÿ
            localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
            renderList();
            
            // èƒŒæ™¯ä¸Šå‚³åˆ°é›²ç«¯
            syncStatus.innerText = "ğŸ”„ åŒæ­¥ä¸­...";
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(items)
                });
                syncStatus.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥æˆåŠŸ";
            } catch (e) {
                console.error("é›²ç«¯ä¸Šå‚³å¤±æ•—", e);
                syncStatus.innerText = "âŒ åŒæ­¥å¤±æ•—ï¼Œå·²å­˜è‡³æœ¬æ©Ÿ";
            }
        }

        // --- 3. åœ–ç‰‡å£“ç¸® ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500;
                        const scale = MAX_WIDTH / img.width;
                        if (scale >= 1) { resolve(img.src); return; } // å¦‚æœåœ–å¤ å°å°±ä¸å£“äº†
                        
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); // å£“ç¸®ç‚º JPG
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // --- 4. è¡¨å–®æäº¤ ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('.btn-submit');
            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";

            try {
                const editId = document.getElementById('editId').value;
                let imgData = null;
                const imgInput = document.getElementById('imageInput');

                if (imgInput.files[0]) {
                    imgData = await compressImage(imgInput.files[0]);
                }

                const rawData = {
                    name: document.getElementById('name').value,
                    orderDate: document.getElementById('orderDate').value,
                    source: document.getElementById('source').value,
                    contact: document.getElementById('contact').value,
                    price: Number(document.getElementById('price').value) || 0,
                    secondPay: Number(document.getElementById('secondPay').value) || 0,
                    shipping: Number(document.getElementById('shipping').value) || 0,
                    notes: document.getElementById('notes').value
                };

                if (editId) {
                    // æ›´æ–°
                    const index = items.findIndex(i => i.id == editId);
                    if (index > -1) {
                        items[index] = { ...items[index], ...rawData, imageSrc: imgData || items[index].imageSrc };
                    }
                } else {
                    // æ–°å¢
                    const newItem = { id: Date.now(), ...rawData, imageSrc: imgData || null };
                    items.unshift(newItem);
                }
                
                await saveData();
                form.reset();
                document.getElementById('editId').value = '';
                document.getElementById('orderDate').valueAsDate = new Date();
                
            } catch(err) {
                alert("å„²å­˜å¤±æ•—: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "å„²å­˜";
            }
        });

        // --- 5. æ¸²æŸ“èˆ‡æ“ä½œ ---
        function renderList() {
            grid.innerHTML = '';
            items.forEach(item => {
                const total = (item.price || 0) + (item.secondPay || 0) + (item.shipping || 0);
                const card = document.createElement('div');
                card.className = 'merch-card';
                card.innerHTML = `
                    <div class="card-header">
                        ${item.imageSrc ? `<img src="${item.imageSrc}" class="card-thumb">` : `<div class="card-thumb"></div>`}
                        <div>
                            <div class="card-title">${item.name}</div>
                            <div class="card-subtitle">${item.orderDate} Â· ${item.source || ''}</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="info-row"><span>å–®åƒ¹</span><span>${item.price}</span></div>
                        <div class="info-row"><span>äºŒè£œ</span><span>${item.secondPay}</span></div>
                        <div class="info-row"><span>é‹è²»</span><span>${item.shipping}</span></div>
                        <div class="total-row">ç¸½è¨ˆ: NT$ ${total}</div>
                        <div class="card-actions">
                            <button class="action-btn" onclick='editItem(${item.id})'>ç·¨è¼¯</button>
                            <button class="action-btn" style="color:red" onclick='deleteItem(${item.id})'>åˆªé™¤</button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        window.editItem = function(id) {
            const item = items.find(i => i.id === id);
            if(!item) return;
            document.getElementById('editId').value = item.id;
            document.getElementById('name').value = item.name;
            document.getElementById('orderDate').value = item.orderDate;
            document.getElementById('source').value = item.source;
            document.getElementById('contact').value = item.contact;
            document.getElementById('price').value = item.price;
            document.getElementById('secondPay').value = item.secondPay;
            document.getElementById('shipping').value = item.shipping;
            document.getElementById('notes').value = item.notes;
            window.scrollTo(0, 0);
        }

        window.deleteItem = function(id) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
                items = items.filter(i => i.id !== id);
                saveData();
            }
        }

        // --- 6. PWA Service Worker ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swContent = `
                    const CACHE_NAME = 'cortis-v8-cache';
                    const urlsToCache = ['/', 'index.html', 'manifest.json', 'icon.png']; // å‡è¨­ä½ æœ‰é€™äº›æª”æ¡ˆ
                    self.addEventListener('install', event => {
                        event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                    });
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => response || fetch(event.request))
                        );
                    });
                `;
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker è¨»å†ŠæˆåŠŸ:', reg.scope))
                    .catch(err => console.error('Service Worker è¨»å†Šå¤±æ•—:', err));
            }
        }
    </script>
</body>
</html>
