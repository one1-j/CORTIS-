<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CORTIS (V9 é›²ç«¯ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-color: #F0ECE6; --card-bg: #FFFFFF; 
            --text-main: #262626; --text-sub: #666666;
            --border: 2px solid #262626; --accent: #d63031; 
            --nav-height: 70px; --select-color: #27ae60;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg-color); color: var(--text-main); 
            font-family: 'Noto Sans TC', 'Inter', sans-serif; margin: 0; padding: 0; 
            padding-bottom: calc(var(--nav-height) + 80px); min-height: 100vh; 
        }

        /* ğŸ”’ é–å®šç•«é¢ */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: transform 0.3s ease-in-out;
        }
        .pin-container { text-align: center; }
        .pin-title { font-size: 2rem; font-weight: 900; margin-bottom: 20px; }
        .pin-input {
            padding: 15px; font-size: 24px; text-align: center; letter-spacing: 10px;
            border: 2px solid var(--text-main); border-radius: 8px; width: 200px;
            background: #fff; outline: none; font-family: monospace;
        }
        .pin-hint { font-size: 12px; color: var(--text-sub); margin-top: 15px; }

        /* é ‚éƒ¨å·¥å…· */
        .top-container {
            background: var(--bg-color); position: sticky; top: 0; z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.1); padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .search-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-row { display: flex; gap: 10px; align-items: center; }
        .search-box { flex: 1; position: relative; }
        .search-input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #999; border-radius: 4px; background: var(--card-bg); font-size: 14px; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        .sort-btn { background: var(--text-main); color: var(--bg-color); border: none; padding: 0 15px; border-radius: 4px; font-size: 13px; font-weight: bold; white-space: nowrap; cursor: pointer; }
        .month-select { flex: 1; padding: 8px; border: 2px solid var(--text-main); border-radius: 4px; background: #fff; font-weight: bold; font-size: 13px; color: var(--text-main); }

        /* é›²ç«¯ç‹€æ…‹ç‡ˆ */
        .sync-status {
            width: 10px; height: 10px; border-radius: 50%; background: #ccc;
            display: inline-block; margin-right: 5px;
        }
        .sync-status.ok { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .sync-status.loading { background: #f1c40f; animation: pulse 1s infinite; }
        .sync-status.error { background: #e74c3c; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* å…§å®¹å€å¡Š */
        .view-section { display: none; padding: 20px; max-width: 1000px; margin: 0 auto; animation: fadeIn 0.2s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        h2.page-title { font-size: 1.8rem; font-weight: 900; margin: 0 0 20px 0; border-bottom: var(--border); padding-bottom: 10px; }
        
        .card-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .card-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .merch-card { background: var(--card-bg); border: var(--border); display: flex; flex-direction: column; position: relative; transition: all 0.2s; }
        .merch-card.selected { border-color: var(--select-color); box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.3); }
        .card-select-overlay { position: absolute; top: 10px; left: 10px; z-index: 5; }
        .custom-checkbox { width: 24px; height: 24px; border: 2px solid var(--text-main); background: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; color: transparent; cursor: pointer; }
        .merch-card.selected .custom-checkbox { background: var(--text-main); color: #fff; }
        .card-status-bar { height: 6px; background: #eee; width: 100%; display: flex; }
        .status-segment { flex: 1; border-right: 1px solid #fff; opacity: 0.2; background: var(--text-main); }
        .status-segment.active { opacity: 1; }
        .card-header { padding: 15px; padding-left: 45px; display: flex; gap: 15px; border-bottom: 1px dashed #ccc; }
        .card-thumb { width: 80px; height: 80px; background: #eee; border: 1px solid #ccc; object-fit: cover; flex-shrink: 0; }
        .card-title-group { flex: 1; overflow: hidden; }
        .category-tag { font-size: 11px; background: #eee; padding: 2px 6px; border-radius: 2px; font-weight: 600; display: inline-block; margin-bottom: 4px; }
        .group-tag { font-size: 11px; background: var(--text-main); color: #fff; padding: 2px 6px; border-radius: 2px; font-weight: 600; display: inline-block; margin-bottom: 4px; margin-right: 5px; }
        .remove-group { cursor: pointer; margin-left: 5px; opacity: 0.7; }
        .card-title { font-size: 17px; font-weight: 900; margin: 0 0 5px 0; line-height: 1.3; }
        .card-subtitle { font-size: 13px; color: var(--text-sub); }
        .contact-link { color: #000; text-decoration: underline; font-weight: bold; cursor: pointer; }
        
        .info-grid { padding: 15px; display: grid; grid-template-columns: 85px 1fr; gap: 8px; font-size: 14px; align-items: baseline; }
        .label { color: var(--text-sub); font-weight: 500; text-align-last: justify; }
        .value { font-weight: 600; text-align: right; font-family: 'Inter', monospace; }
        .value.highlight { font-weight: 900; font-size: 16px; border-top: 1px dashed #999; padding-top: 5px; margin-top: 5px; }
        
        .checklist-row { padding: 10px 15px; background: #f9f9f9; border-top: 1px solid #eee; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 5px; }
        .check-item { font-size: 12px; display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px 6px; border-radius: 3px; }
        .check-item.checked { background: #e0e0e0; font-weight: bold; }
        .check-box { width: 12px; height: 12px; border: 1px solid #333; display: inline-block; }
        .check-item.checked .check-box { background: #333; }
        
        .card-actions { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; }
        .action-btn { background: transparent; border: none; padding: 12px 2px; font-size: 12px; font-weight: 700; border-right: 1px solid #eee; color: var(--text-main); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .action-btn:last-child { border: none; }
        .action-btn:disabled { color: #ccc; cursor: default; }

        .form-container { background: var(--card-bg); padding: 20px; border: var(--border); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-col { flex: 1; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 0; background: #fff; font-size: 15px; color: var(--text-main); }
        .btn-main { width: 100%; background: var(--text-main); color: #fff; padding: 15px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; letter-spacing: 1px; }
        
        .stats-box { background: var(--text-main); color: #fff; padding: 20px; margin-bottom: 20px; text-align: center; }
        .stats-big-num { font-size: 32px; font-weight: 900; font-family: monospace; }
        .settings-group { background: #fff; border: var(--border); padding: 20px; margin-bottom: 20px; }
        .btn-backup { background: #eee; border: 1px solid #ccc; padding: 12px; width: 100%; margin-bottom: 10px; font-weight: bold; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-excel { background: #27ae60; color: white; border: none; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: var(--card-bg); border-top: var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; color: #999; font-size: 11px; font-weight: 700; cursor: pointer; padding-top: 10px; }
        .nav-item.active { color: var(--text-main); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }

        .bulk-actions-bar { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(150px); background: var(--text-main); color: #fff; padding: 10px 20px; display: flex; gap: 15px; align-items: center; border-radius: 50px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: transform 0.3s; z-index: 99; }
        .bulk-actions-bar.active { transform: translateX(-50%) translateY(0); }
        .bulk-btn { background: #fff; color: #000; border: none; padding: 5px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        .hidden { display: none; }
        .text-red { color: var(--accent); }
    </style>
</head>
<body>

    <!-- ğŸ”’ å¯†ç¢¼é–ç•«é¢ -->
    <div id="lockScreen">
        <div class="pin-container">
            <div class="pin-title">LOCKED</div>
            <div class="pin-msg">è«‹è¼¸å…¥ PIN ç¢¼ä»¥è§£é–</div>
            <input type="password" id="pinInput" class="pin-input" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            <div class="pin-hint">é è¨­å¯†ç¢¼: 0000</div>
        </div>
    </div>

    <!-- é ‚éƒ¨å·¥å…·å€ -->
    <div class="top-container">
        <div class="search-row">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹..." oninput="renderList()">
            </div>
            <button class="sort-btn" onclick="toggleSort()">â‡…</button>
        </div>
        <div class="filter-row">
            <select id="monthFilter" class="month-select" onchange="renderList()">
                <option value="all">ğŸ“… æ‰€æœ‰æœˆä»½</option>
            </select>
            <div id="syncIndicator" class="sync-status" title="é›²ç«¯åŒæ­¥ç‹€æ…‹"></div>
        </div>
    </div>

    <!-- åˆ—è¡¨é  -->
    <div id="view-home" class="view-section active">
        <div id="currentMonthStats" style="text-align:center; padding:10px; font-size:14px; color:#666; display:none;">
            æœ¬æœˆç¸½è¨ˆ: <span id="monthTotal" style="color:#000; font-weight:bold;">NT$ 0</span>
        </div>
        <div id="merchGrid" class="card-grid"></div>
        <div id="emptyState" style="text-align:center; padding:50px; color:#999; display:none;">ç›®å‰æ²’æœ‰ç´€éŒ„</div>
    </div>

    <!-- æ–°å¢é  -->
    <div id="view-add" class="view-section">
        <h2 class="page-title" id="pageTitle">æ–°å¢ç´€éŒ„</h2>
        <div class="form-container">
            <form id="merchForm">
                <input type="hidden" id="editId">
                <div class="form-group"><label>å•†å“åç¨± <span style="color:red">*</span></label><input type="text" id="name" required></div>
                <div class="form-row">
                    <div class="form-col"><label>åˆ†é¡</label><select id="category"><option>å‘¨é‚Š</option><option>å°ˆè¼¯</option><option>å°å¡</option><option>ç¥¨å‹™</option><option>å…¶ä»–</option></select></div>
                    <div class="form-col"><label>ä¸‹å–®æ—¥æœŸ <span style="color:red">*</span></label><input type="date" id="orderDate" required></div>
                </div>
                <div class="form-group"><label>è³£å®¶è¯çµ¡</label><div class="form-row" style="margin:0;"><div class="form-col"><input type="text" id="contact" placeholder="åç¨±"></div><div class="form-col"><input type="url" id="contactLink" placeholder="é€£çµ"></div></div></div>
                <div class="form-group"><label>ä»˜æ¬¾æ–¹å¼</label><select id="paymentType" onchange="toggleTransferFields()"><option value="Pending">å¾…ä»˜æ¬¾</option><option value="COD">è²¨åˆ°ä»˜æ¬¾</option><option value="Transfer">éŠ€è¡ŒåŒ¯æ¬¾</option></select></div>
                <div id="transferFields" class="hidden" style="background:#eee; padding:10px; margin-bottom:15px;"><div class="form-row"><div class="form-col"><label>åŒ¯æ¬¾æ—¥æœŸ</label><input type="date" id="transferDate"></div><div class="form-col"><label>é‡‘é¡</label><input type="number" id="transferAmount"></div></div></div>
                <div class="form-group"><label>è²»ç”¨ (NT$)</label><div class="info-grid" style="grid-template-columns:1fr 1fr 1fr; background:#f9f9f9; padding:10px; gap:10px;"><div><label style="text-align:center;">å–®åƒ¹</label><input type="number" id="price" style="text-align:right;"></div><div><label style="text-align:center;">äºŒè£œ</label><input type="number" id="secondPay" style="text-align:right;"></div><div><label style="text-align:center;">é‹è²»</label><input type="number" id="shipping" style="text-align:right;"></div></div></div>
                <div class="form-group"><label>é€£çµ</label><input type="url" id="link" placeholder="è¨‚è³¼..." style="margin-bottom:5px;"><input type="url" id="reconcileLink" placeholder="å°å¸³è¡¨..." style="margin-bottom:5px;"><input type="url" id="sellerLink" placeholder="è³£è²¨ä¾¿..."></div>
                <div class="form-group"><label>å‚™è¨»</label><textarea id="notes" style="height:60px;"></textarea></div>
                <div class="form-group"><label>åœ–ç‰‡</label><input type="file" id="imageInput" accept="image/*"></div>
                <button type="submit" class="btn-main" id="submitBtn">å„²å­˜</button>
                <button type="button" class="btn-main" id="cancelBtn" onclick="resetForm()" style="background:#999; margin-top:10px; display:none;">å–æ¶ˆç·¨è¼¯</button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†é  -->
    <div id="view-settings" class="view-section">
        <h2 class="page-title">ç®¡ç†</h2>
        <div class="stats-box"><div>ç¸½èŠ±è²»</div><div class="stats-big-num" id="statTotalSpent">NT$ 0</div><div>å“é …æ•¸: <span id="statTotalItems">0</span></div></div>
        
        <h3 style="margin-bottom:10px;">è³‡æ–™åŒ¯å…¥</h3>
        <div class="settings-group">
            <button class="btn-backup btn-excel" onclick="downloadTemplate()">ğŸ“Š ä¸‹è¼‰ Excel ç¯„æœ¬</button>
            <div style="position:relative; margin-top:10px;"><button class="btn-backup btn-excel" style="background:#262626;" onclick="document.getElementById('excelInput').click()">ğŸ“¥ åŒ¯å…¥ Excel</button><input type="file" id="excelInput" onchange="importExcel(this)" accept=".xlsx, .xls, .csv" style="display:none;"></div>
        </div>
        <h3 style="margin-bottom:10px;">è³‡æ–™å‚™ä»½</h3>
        <div class="settings-group">
            <button class="btn-backup" onclick="exportData()">â¬‡ ä¸‹è¼‰ JSON å‚™ä»½</button>
            <div style="position:relative; margin-top:10px;"><button class="btn-backup" onclick="document.getElementById('jsonInput').click()">â¬† åŒ¯å…¥ JSON å‚™ä»½</button><input type="file" id="jsonInput" onchange="importData(this)" accept=".json" style="display:none;"></div>
            <button class="btn-backup" onclick="forceCloudSync()" style="background:#3498db; color:fff; margin-top:20px;">â˜ å¼·åˆ¶é›²ç«¯åŒæ­¥</button>
            <button class="btn-backup" onclick="clearAllData()" style="background:var(--accent); color:#fff; margin-top:10px;">âš  æ¸…ç©ºè³‡æ–™</button>
        </div>
    </div>

    <div id="bulkActions" class="bulk-actions-bar">
        <div style="font-size:14px;">å·²é¸ <span id="selectedCount">0</span> ç­†</div>
        <button class="bulk-btn" onclick="mergeSelectedItems()">ğŸ”— åˆä½µ</button>
        <button class="bulk-btn" onclick="clearSelection()" style="background:#666; color:#fff;">å–æ¶ˆ</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchView('home', this)"><span class="nav-icon">â˜°</span>åˆ—è¡¨</div>
        <div class="nav-item" onclick="switchView('add', this)"><span class="nav-icon">ï¼‹</span>æ–°å¢</div>
        <div class="nav-item" onclick="switchView('settings', this)"><span class="nav-icon">âš™</span>ç®¡ç†</div>
    </div>

    <script>
        // --- è¨­å®šèˆ‡è®Šæ•¸ ---
        // è«‹ç¢ºèªé€™å€‹ URL æ˜¯æ‚¨æä¾›çš„ Google Apps Script éƒ¨ç½²ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbyeGblocTD-g8e3yUbG0YSMBRbT-6Uwfu2gF09Bjgqt32C_GIjBwnl-Ni2-cfDwXQfl4g/exec";
        const APP_PIN = "0000"; // é è¨­å¯†ç¢¼
        const STORAGE_KEY = 'cortis_v9_data';
        
        let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let sortDesc = true;
        let selectedIds = new Set();
        let isSyncing = false;

        const views = { home: document.getElementById('view-home'), add: document.getElementById('view-add'), settings: document.getElementById('view-settings') };
        const STATUS_KEYS = ['notArrived', 'pendingShip', 'shipped', 'pickedUp'];
        const STATUS_LABELS = { notArrived:'æœªåˆ°è²¨', pendingShip:'å¾…å‡ºè²¨', shipped:'å·²å‡ºè²¨', pickedUp:'å–è²¨' };
        const PAYMENT_LABELS = { Pending:'å¾…ä»˜æ¬¾', COD:'è²¨åˆ°ä»˜æ¬¾', Transfer:'éŠ€è¡ŒåŒ¯æ¬¾' };

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            // PIN Lock Logic
            const pinInput = document.getElementById('pinInput');
            pinInput.focus();
            pinInput.addEventListener('input', (e) => {
                if (e.target.value === APP_PIN) {
                    document.getElementById('lockScreen').style.transform = 'translateY(-100%)';
                    initApp();
                }
            });
        };

        function initApp() {
            renderList(); updateStats(); populateMonthFilter();
            document.getElementById('orderDate').valueAsDate = new Date();
            // å•Ÿå‹•é›²ç«¯åŒæ­¥
            syncWithCloud();
        }

        // --- é›²ç«¯åŒæ­¥æ ¸å¿ƒ ---
        async function syncWithCloud() {
            const ind = document.getElementById('syncIndicator');
            if(isSyncing) return;
            isSyncing = true;
            ind.className = 'sync-status loading';

            try {
                // 1. å˜—è©¦ä¸‹è¼‰é›²ç«¯è³‡æ–™ (GET)
                const res = await fetch(API_URL);
                const cloudData = await res.json();
                
                if(Array.isArray(cloudData) && cloudData.length > 0) {
                    // ç°¡å–®åˆä½µé‚è¼¯ï¼šé›²ç«¯æœ‰è³‡æ–™å°±è¦†è“‹æœ¬åœ° (æ‚¨ä¹Ÿå¯ä»¥æ”¹æˆæ›´è¤‡é›œçš„åˆä½µ)
                    // é€™è£¡æ¡ç”¨ï¼šå¦‚æœé›²ç«¯è³‡æ–™ç­†æ•¸æ¯”æœ¬åœ°å¤šï¼Œæˆ–æœ¬åœ°æ˜¯ç©ºçš„ï¼Œå°±ç”¨é›²ç«¯çš„
                    if(cloudData.length >= items.length || items.length === 0) {
                        items = cloudData;
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                        renderList(); updateStats(); populateMonthFilter();
                        console.log("å·²å¾é›²ç«¯è¼‰å…¥è³‡æ–™");
                    }
                }
                
                ind.className = 'sync-status ok';
            } catch(e) {
                console.warn("é›²ç«¯è®€å–å¤±æ•—(é›¢ç·š?)", e);
                ind.className = 'sync-status error';
            } finally {
                isSyncing = false;
            }
        }

        async function forceCloudSync() {
            if(!confirm("ç¢ºå®šè¦å°‡ç›®å‰çš„è³‡æ–™å¼·åˆ¶ä¸Šå‚³è¦†è“‹é›²ç«¯å—ï¼Ÿ")) return;
            const ind = document.getElementById('syncIndicator');
            ind.className = 'sync-status loading';
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(items)
                });
                alert("å·²é€å‡ºä¸Šå‚³è«‹æ±‚");
                ind.className = 'sync-status ok';
            } catch(e) {
                alert("ä¸Šå‚³å¤±æ•—");
                ind.className = 'sync-status error';
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                updateStats();
                // èƒŒæ™¯è‡ªå‹•ä¸Šå‚³
                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(items)
                }).catch(e => console.log("èƒŒæ™¯ä¸Šå‚³å¤±æ•—", e));
            } catch (e) {
                alert("âŒ å„²å­˜ç©ºé–“ä¸è¶³ï¼Œè«‹æ¸…é™¤éƒ¨åˆ†åœ–ç‰‡");
            }
        }

        // --- ä»‹é¢é‚è¼¯ ---
        function switchView(view, el) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            views[view].classList.add('active'); el.classList.add('active');
            if(view === 'home') renderList();
            window.scrollTo(0,0);
        }

        function populateMonthFilter() {
            const select = document.getElementById('monthFilter');
            const currentVal = select.value;
            const months = [...new Set(items.map(i => i.orderDate.substring(0, 7)))].sort().reverse();
            let html = '<option value="all">ğŸ“… æ‰€æœ‰æœˆä»½</option>';
            months.forEach(m => {
                const [y, mm] = m.split('-');
                html += `<option value="${m}">${y}å¹´ ${mm}æœˆ</option>`;
            });
            select.innerHTML = html;
            if(months.includes(currentVal)) select.value = currentVal; else select.value = "all";
        }

        function renderList() {
            const grid = document.getElementById('merchGrid');
            grid.innerHTML = '';
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const monthVal = document.getElementById('monthFilter').value;

            let filtered = items.filter(i => {
                const matchK = (i.name||'').toLowerCase().includes(keyword);
                const matchM = monthVal === 'all' || i.orderDate.startsWith(monthVal);
                return matchK && matchM;
            });

            filtered.sort((a,b) => sortDesc ? new Date(b.orderDate)-new Date(a.orderDate) : new Date(a.orderDate)-new Date(b.orderDate));
            document.getElementById('emptyState').style.display = filtered.length ? 'none' : 'block';
            
            const currentTotal = filtered.reduce((acc, i) => acc + (i.price||0) + (i.secondPay||0) + (i.shipping||0), 0);
            const statsDiv = document.getElementById('currentMonthStats');
            if(monthVal !== 'all') {
                statsDiv.style.display = 'block';
                document.getElementById('monthTotal').innerText = `NT$ ${currentTotal.toLocaleString()}`;
            } else { statsDiv.style.display = 'none'; }

            filtered.forEach(item => {
                const total = (item.price||0) + (item.secondPay||0) + (item.shipping||0);
                let checksHtml = '';
                STATUS_KEYS.forEach(k => {
                    const checked = item.status[k] ? 'checked' : '';
                    checksHtml += `<div class="check-item ${checked}" onclick="toggleStatus(${item.id}, '${k}')"><span class="check-box"></span> ${STATUS_LABELS[k]}</div>`;
                });
                
                let contactDisplay = item.contact || '-';
                if(item.contactLink) contactDisplay = `<a class="contact-link" onclick="window.open('${item.contactLink}', '_blank')">${item.contact || 'é€£çµ'}</a>`;
                let groupHtml = item.group ? `<span class="group-tag">ğŸ“¦ ${item.group} <span class="remove-group" onclick="ungroupItem(${item.id})">Ã—</span></span>` : '';
                const isSelected = selectedIds.has(item.id) ? 'selected' : '';
                const checkMark = selectedIds.has(item.id) ? 'âœ”' : '';
                const openUrl = (url) => url ? `window.open('${url}','_blank')` : '';
                const btnStyle = (url) => url ? '' : 'color:#ccc; cursor:default;';

                const card = document.createElement('div');
                card.className = `merch-card ${isSelected}`;
                card.innerHTML = `
                    <div class="card-select-overlay" onclick="toggleSelection(${item.id})"><div class="custom-checkbox">${checkMark}</div></div>
                    <div class="card-status-bar">${STATUS_KEYS.map(k => `<div class="status-segment ${item.status[k]?'active':''}"></div>`).join('')}</div>
                    <div class="card-header">${item.imageSrc ? `<img src="${item.imageSrc}" class="card-thumb">` : `<div class="card-thumb"></div>`}
                        <div class="card-title-group"><div>${groupHtml}<span class="category-tag">${item.category||'å‘¨é‚Š'}</span></div><div class="card-title">${item.name}</div><div class="card-subtitle">${item.orderDate} Â· ${item.source||''}</div></div>
                    </div>
                    <div class="info-grid">
                        <span class="label">è³£å®¶è¯çµ¡</span><span class="value" style="font-size:13px;">${contactDisplay}</span>
                        <span class="label">ä»˜æ¬¾æ–¹å¼</span><span class="value" style="font-size:13px;">${PAYMENT_LABELS[item.paymentType] || item.paymentType}</span>
                        <span class="label">å–®åƒ¹</span><span class="value">${item.price||0}</span>
                        <span class="label">äºŒè£œ</span><span class="value">${item.secondPay||0}</span>
                        <span class="label">åœ‹éš›é‹è²»</span><span class="value">${item.shipping||0}</span>
                        <span class="label" style="font-weight:900; color:#000;">ç¸½è¨ˆ</span><span class="value highlight">NT$ ${total}</span>
                    </div>
                    <div class="checklist-row">${checksHtml}</div>
                    <div class="card-actions">
                        <button class="action-btn" onclick="editItem(${item.id})">ç·¨è¼¯</button>
                        <button class="action-btn" onclick="${openUrl(item.link)}" style="${btnStyle(item.link)}">è¨‚è³¼</button>
                        <button class="action-btn" onclick="${openUrl(item.reconcileLink)}" style="${btnStyle(item.reconcileLink)}">å°å¸³è¡¨</button>
                        <button class="action-btn text-red" onclick="deleteItem(${item.id})">åˆªé™¤</button>
                    </div>`;
                grid.appendChild(card);
            });
            updateBulkBar();
        }

        // --- å£“ç¸®èˆ‡å„²å­˜ ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                        const maxW = 800; const scale = maxW/img.width;
                        const w = (scale<1)?maxW:img.width; const h = (scale<1)?img.height*scale:img.height;
                        cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                        resolve(cvs.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        document.getElementById('merchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!document.getElementById('name').value || !document.getElementById('orderDate').value) { alert("è«‹å¡«å¯«åç¨±èˆ‡æ—¥æœŸ"); return; }
            try {
                const editId = document.getElementById('editId').value;
                const imgInput = document.getElementById('imageInput');
                let imgData = null;
                if(imgInput.files[0]) imgData = await compressImage(imgInput.files[0]);

                const rawData = {
                    name: document.getElementById('name').value, category: document.getElementById('category').value,
                    orderDate: document.getElementById('orderDate').value, source: document.getElementById('source').value, 
                    contact: document.getElementById('contact').value, contactLink: document.getElementById('contactLink').value,
                    paymentType: document.getElementById('paymentType').value, transferDate: document.getElementById('transferDate').value, 
                    transferAmount: Number(document.getElementById('transferAmount').value), price: Number(document.getElementById('price').value), 
                    secondPay: Number(document.getElementById('secondPay').value), shipping: Number(document.getElementById('shipping').value), 
                    link: document.getElementById('link').value, reconcileLink: document.getElementById('reconcileLink').value,
                    sellerLink: document.getElementById('sellerLink').value, notes: document.getElementById('notes').value
                };

                if(editId) {
                    const idx = items.findIndex(i => i.id == editId);
                    if(idx > -1) items[idx] = { ...items[idx], ...rawData, imageSrc: imgData || items[idx].imageSrc };
                } else {
                    items.unshift({ id: Date.now(), ...rawData, imageSrc: imgData||'', group:null, status: {notArrived:true, pendingShip:false, shipped:false, pickedUp:false} });
                }
                saveData(); populateMonthFilter(); resetForm(); switchView('home', document.querySelectorAll('.nav-item')[0]);
            } catch (err) { alert("å„²å­˜å¤±æ•—: " + err.message); }
        });

        // --- å…¶ä»–å·¥å…· ---
        function toggleSelection(id) { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); renderList(); }
        function clearSelection() { selectedIds.clear(); renderList(); }
        function updateBulkBar() { const bar = document.getElementById('bulkActions'); if(selectedIds.size > 0) { bar.classList.add('active'); document.getElementById('selectedCount').innerText = selectedIds.size; } else { bar.classList.remove('active'); } }
        function mergeSelectedItems() { const name = prompt("è¼¸å…¥ä½µå–®åç¨±:"); if(name) { items.forEach(i => { if(selectedIds.has(i.id)) i.group = name; }); clearSelection(); saveData(); renderList(); } }
        function ungroupItem(id) { if(confirm("ç§»é™¤ä½µå–®ï¼Ÿ")) { const i = items.find(x => x.id === id); if(i) { i.group = null; saveData(); renderList(); } } }
        function toggleSort() { sortDesc = !sortDesc; renderList(); }
        function updateStats() { const total = items.reduce((acc, i) => acc + (i.price||0) + (i.secondPay||0) + (i.shipping||0), 0); document.getElementById('statTotalSpent').innerText = `NT$ ${total.toLocaleString()}`; document.getElementById('statTotalItems').innerText = items.length; }
        
        function editItem(id) {
            const item = items.find(i => i.id === id); if(!item) return;
            document.getElementById('editId').value = item.id; document.getElementById('name').value = item.name;
            document.getElementById('category').value = item.category; document.getElementById('orderDate').value = item.orderDate;
            document.getElementById('source').value = item.source || ''; document.getElementById('contact').value = item.contact;
            document.getElementById('contactLink').value = item.contactLink || ''; document.getElementById('paymentType').value = item.paymentType; 
            document.getElementById('transferDate').value = item.transferDate; document.getElementById('transferAmount').value = item.transferAmount; 
            document.getElementById('price').value = item.price; document.getElementById('secondPay').value = item.secondPay; 
            document.getElementById('shipping').value = item.shipping; document.getElementById('link').value = item.link; 
            document.getElementById('reconcileLink').value = item.reconcileLink || ''; document.getElementById('sellerLink').value = item.sellerLink; 
            document.getElementById('notes').value = item.notes; toggleTransferFields();
            document.getElementById('pageTitle').innerText = "ç·¨è¼¯ç´€éŒ„"; document.getElementById('submitBtn').innerText = "æ›´æ–°è³‡æ–™"; document.getElementById('cancelBtn').style.display = 'block';
            switchView('add', document.querySelectorAll('.nav-item')[1]);
        }
        function resetForm() { form.reset(); document.getElementById('editId').value = ''; document.getElementById('pageTitle').innerText="æ–°å¢ç´€éŒ„"; document.getElementById('submitBtn').innerText="å„²å­˜ç´€éŒ„"; document.getElementById('cancelBtn').style.display='none'; toggleTransferFields(); }
        function deleteItem(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { items = items.filter(i => i.id !== id); if(selectedIds.has(id)) selectedIds.delete(id); saveData(); renderList(); populateMonthFilter(); } }
        function toggleStatus(id, k) { const i = items.find(x => x.id === id); if(i) { i.status[k] = !i.status[k]; saveData(); renderList(); } }
        function toggleTransferFields() { document.getElementById('transferFields').style.display = document.getElementById('paymentType').value === 'Transfer' ? 'block' : 'none'; }
        
        function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(items,null,2)],{type:'application/json'})); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function importData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload=e=>{ try{ items=JSON.parse(e.target.result); saveData(); populateMonthFilter(); renderList(); alert('åŒ¯å…¥æˆåŠŸ'); }catch{ alert('éŒ¯èª¤'); } }; r.readAsText(f); }
        function clearAllData() { if(confirm('æ¸…ç©ºï¼Ÿ')) { items=[]; saveData(); populateMonthFilter(); renderList(); } }

        function downloadTemplate() {
            if(typeof XLSX === 'undefined') { alert('Excel å·¥å…·æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); return; }
            const data = [{"å•†å“åç¨±":"ç¯„ä¾‹","åˆ†é¡":"å‘¨é‚Š","ä¸‹å–®æ—¥æœŸ":"2025-01-01","è³¼è²·ä¾†æº":"å®˜ç¶²","è³£å®¶åç¨±":"@abc","è³£å®¶é€£çµ":"","ä»˜æ¬¾æ–¹å¼ (å¾…ä»˜æ¬¾/è²¨åˆ°ä»˜æ¬¾/éŠ€è¡ŒåŒ¯æ¬¾)":"éŠ€è¡ŒåŒ¯æ¬¾","åŒ¯æ¬¾æ—¥æœŸ":"2025-01-01","åŒ¯æ¬¾é‡‘é¡":500,"å–®åƒ¹":500,"äºŒè£œ":0,"åœ‹éš›é‹è²»":60,"è¨‚è³¼é€£çµ":"","å°å¸³è¡¨é€£çµ":"","è³£è²¨ä¾¿é€£çµ":"","å‚™è¨»":""}];
            XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(data), "Sheet1")), "CORTIS_V9ç¯„æœ¬.xlsx");
        }
        function importExcel(input) {
            if(typeof XLSX === 'undefined') { alert('Excel å·¥å…·æœªè¼‰å…¥'); input.value=''; return; }
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if(json.length === 0) throw new Error("ç„¡è³‡æ–™");
                    const newItems = json.map(row => {
                        let pType = "Pending"; const pRaw = row["ä»˜æ¬¾æ–¹å¼ (å¾…ä»˜æ¬¾/è²¨åˆ°ä»˜æ¬¾/éŠ€è¡ŒåŒ¯æ¬¾)"] || "";
                        if(pRaw.includes("è²¨åˆ°")) pType = "COD"; else if(pRaw.includes("åŒ¯æ¬¾")) pType = "Transfer";
                        return {
                            id: Date.now() + Math.floor(Math.random()*100000),
                            name: row["å•†å“åç¨±"] || "æœªå‘½å", category: row["åˆ†é¡"] || "å‘¨é‚Š",
                            orderDate: row["ä¸‹å–®æ—¥æœŸ"] || new Date().toISOString().split('T')[0],
                            source: row["è³¼è²·ä¾†æº"] || "", contact: row["è³£å®¶åç¨±"] || "", contactLink: row["è³£å®¶é€£çµ"] || "",
                            paymentType: pType, transferDate: row["åŒ¯æ¬¾æ—¥æœŸ"] || "",
                            transferAmount: Number(row["åŒ¯æ¬¾é‡‘é¡"])||0, price: Number(row["å–®åƒ¹"])||0,
                            secondPay: Number(row["äºŒè£œ"])||0, shipping: Number(row["åœ‹éš›é‹è²»"])||0,
                            link: row["è¨‚è³¼é€£çµ"]||"", reconcileLink: row["å°å¸³è¡¨é€£çµ"]||"", sellerLink: row["è³£è²¨ä¾¿é€£çµ"]||"", notes: row["å‚™è¨»"]||"",
                            imageSrc: "", group: null, status: { notArrived:true, pendingShip:false, shipped:false, pickedUp:false }
                        };
                    });
                    items = [...newItems, ...items]; saveData(); populateMonthFilter(); renderList(); alert(`ğŸ‰ åŒ¯å…¥ ${newItems.length} ç­†æˆåŠŸ`);
                } catch (error) { alert("âŒ å¤±æ•—: " + error.message); } 
                finally { input.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
